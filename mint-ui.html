<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onchain Rugs - Minting Interface</title>
    <!-- Include ethers.js with multiple fallbacks -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Fallback system for ethers.js
        function loadEthersFallback() {
            if (typeof ethers !== 'undefined') {
                console.log('Ethers.js loaded successfully from primary CDN');
                return;
            }
            
            console.log('Primary CDN failed, trying fallback CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
            script.onload = function() {
                console.log('Fallback CDN loaded successfully');
            };
            script.onerror = function() {
                console.log('CDN fallback failed, trying local version...');
                const localScript = document.createElement('script');
                localScript.src = './public/ethers.min.js';
                localScript.onload = function() {
                    console.log('Local ethers.js loaded successfully');
                };
                localScript.onerror = function() {
                    console.error('All ethers.js sources failed');
                    document.body.innerHTML += '<div style="position: fixed; top: 0; left: 0; width: 100%; background: red; color: white; padding: 10px; text-align: center; z-index: 9999;">‚ö†Ô∏è Failed to load ethers.js. Please check your internet connection or run a local server.</div>';
                };
                document.head.appendChild(localScript);
            };
            document.head.appendChild(script);
        }
        
        // Check after a short delay
        setTimeout(loadEthersFallback, 100);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            overflow-y: auto;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            overflow-y: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }


        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        /* Network selector styling */
        #networkSelect {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        #networkSelect:hover {
            border-color: #4facfe;
        }

        #networkSelect:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .contract-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-left: 4px solid #4facfe;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            white-space: pre-wrap;
            box-sizing: border-box;
            overflow-x: hidden;
            overflow-y: visible;
            position: relative;
            width: 100%;
        }

        /* Status container for error display */
        .status.error {
            overflow: visible;
            position: relative;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Ensure all pre elements and code blocks have proper overflow handling */
        pre, code, .status pre, .status code, .status div[style*="white-space: pre"] {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: visible;
        }

        /* Prevent horizontal overflow in all containers */
        .status *, .container *, .form-group *, .nft-display * {
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Ensure buttons don't cause overflow */
        button {
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* Specific button styling for error copy buttons */
        .status button {
            min-width: fit-content;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* NUCLEAR ERROR CONTAINMENT - OVERRIDE EVERYTHING */
        .status.error .error-display {
            width: 100% !important;
            max-width: 100% !important;
            overflow: hidden !important;
            box-sizing: border-box !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            contain: layout style paint !important;
            isolation: isolate !important;
        }

        .status.error .error-section {
            width: 100% !important;
            max-width: 100% !important;
            overflow: hidden !important;
            margin-bottom: 15px !important;
            box-sizing: border-box !important;
        }

        .status.error .error-content {
            width: 100% !important;
            max-width: 100% !important;
            overflow-x: auto !important;
            overflow-y: auto !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            box-sizing: border-box !important;
            font-family: 'Courier New', monospace !important;
            line-height: 1.4 !important;
        }

        /* Specific height limits for different error sections */
        .status.error .error-tech-message {
            max-height: 120px !important;
        }

        .status.error .error-stack-trace {
            max-height: 180px !important;
        }

        .status.error .error-properties {
            max-height: 80px !important;
        }

        .status.error .error-context {
            max-height: 100px !important;
        }

        .status.error .error-friendly {
            max-height: 100px !important;
        }

        /* NUCLEAR FORCE - Override ALL nested elements in error display */
        .status.error .error-display *,
        .status.error .error-display pre,
        .status.error .error-display code,
        .status.error .error-display div,
        .status.error .error-display span,
        .status.error .error-display p {
            max-width: 100% !important;
            overflow-x: auto !important;
            overflow-y: visible !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            box-sizing: border-box !important;
            text-overflow: clip !important;
        }

        /* FORCE scrollbars on all error content */
        .status.error .error-content::-webkit-scrollbar {
            width: 8px !important;
            height: 8px !important;
        }

        .status.error .error-content::-webkit-scrollbar-track {
            background: #f1f1f1 !important;
            border-radius: 4px !important;
        }

        .status.error .error-content::-webkit-scrollbar-thumb {
            background: #c1c1c1 !important;
            border-radius: 4px !important;
        }

        .status.error .error-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8 !important;
        }

        /* FORCE button containment */
        .status.error button {
            max-width: 100% !important;
            box-sizing: border-box !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            white-space: nowrap !important;
            text-overflow: ellipsis !important;
            overflow: hidden !important;
        }

        /* PURE CSS ERROR CLASSES - NO INLINE STYLES */
        .status.error .error-message {
            display: block !important;
            margin-bottom: 10px !important;
            font-weight: bold !important;
            color: #721c24 !important;
        }

        .status.error .error-button-container {
            text-align: center !important;
            margin: 10px 0 !important;
        }

        .status.error .error-copy-btn {
            padding: 8px 16px !important;
            background: #6c757d !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            margin: 5px !important;
        }

        .status.error .error-copy-main {
            padding: 12px 24px !important;
            background: #dc3545 !important;
            font-size: 14px !important;
            font-weight: bold !important;
            margin: 10px !important;
        }

        .status.error .error-technical-container {
            border: 2px solid #dc3545 !important;
            border-radius: 6px !important;
            margin: 15px 0 !important;
            background: white !important;
        }

        .status.error .error-technical-header {
            font-weight: bold !important;
            color: #dc3545 !important;
            background: #f8d7da !important;
            padding: 10px !important;
            border-radius: 4px 4px 0 0 !important;
            font-size: 14px !important;
        }

        .status.error .error-technical-content {
            padding: 15px !important;
            background: #f8f9fa !important;
            border-radius: 0 0 4px 4px !important;
        }

        .status.error .error-label {
            font-weight: bold !important;
            margin-bottom: 5px !important;
            color: #495057 !important;
        }

        .status.error .error-label:first-child {
            color: #721c24 !important;
        }

        .status.error .error-label:nth-child(2) {
            color: #856404 !important;
        }

        .status.error .error-label:nth-child(3) {
            color: #004085 !important;
        }

        .status.error .error-label:nth-child(4) {
            color: #0c5460 !important;
        }

        /* Background colors for different error sections */
        .status.error .error-tech-message {
            background: #ffe6e6 !important;
            border: 1px solid #f5c6cb !important;
        }

        .status.error .error-stack-trace {
            background: #fff3cd !important;
            border: 1px solid #ffeaa7 !important;
        }

        .status.error .error-properties {
            background: #e7f3ff !important;
            border: 1px solid #b3d9ff !important;
        }

        .status.error .error-context {
            background: #f0f8ff !important;
            border: 1px solid #add8e6 !important;
        }

        .status.error .error-friendly {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
            padding: 10px !important;
            font-size: 12px !important;
        }

        /* Ensure all error sections have proper styling */
        .status.error .error-section {
            margin-bottom: 15px !important;
        }

        .status.error .error-section:last-child {
            margin-bottom: 0 !important;
        }

        /* Wallet Info Styling */
        .wallet-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }

        .wallet-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .wallet-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .wallet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 14px;
        }

        .wallet-item strong {
            color: #e8f4fd;
            font-weight: 600;
        }

        .wallet-item span {
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .nft-display {
                height: 280px;
                max-width: 100%;
                margin: 10px 0;
            }

            .wallet-info {
                padding: 15px;
                margin: 15px 0;
            }

            .wallet-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .wallet-details {
                gap: 8px;
            }

            .wallet-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                padding: 10px;
                font-size: 13px;
            }

            .wallet-item span {
                font-size: 11px;
                width: 100%;
                text-align: left;
            }
        }

        .nft-display {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 0;
            text-align: center;
            width: 100%;
            max-width: 600px;
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            overflow: hidden;
            margin: 0 auto;
            position: relative;
        }

        .nft-display iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 0;
        }

        .metadata-info {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .metadata-section {
            margin: 15px 0;
        }

        .metadata-json {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            max-width: 100%;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            margin: 10px 0;
            box-sizing: border-box;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            margin-left: 10px;
        }

        .traits-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .trait-item {
            background: #e2e8f0;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #4facfe;
        }

        .trait-name {
            font-weight: bold;
            color: #2d3748;
            font-size: 14px;
        }

        .trait-value {
            color: #4a5568;
            font-size: 13px;
            margin-top: 2px;
        }

        .contract-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .token-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .token-info h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        .token-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® Onchain Rugs - Shape L2</h1>
            <p>Mint and interact with your dynamic NFT rugs with full custom control</p>
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
                üí° <strong>Dynamic Contract Discovery:</strong> Automatically scans for deployed contracts with timestamps<br>
                üîß <strong>Full Algorithm:</strong> Complete p5.js rug generation (not placeholder)<br>
                üö´ <strong>No Scripty.sol:</strong> Standalone contract with embedded assets
            </div>
        </div>

        <!-- Network & Contract Selector -->
        <div class="card" style="margin-bottom: 20px;">
            <h3>üåê Network Configuration</h3>
            <div class="form-group">
                <label for="networkSelect">Select Network:</label>
                <select id="networkSelect" onchange="switchNetwork()">
                    <option value="local">üè† Local (Anvil)</option>
                    <option value="testnet">üß™ Shape Sepolia Testnet</option>
                </select>
            </div>

            <div class="form-group">
                <label for="contractSelector">Select Contract:</label>
                <select id="contractSelector" onchange="selectContract()">
                    <option value="">Loading contracts...</option>
                </select>
                <button class="btn btn-small" onclick="refreshContracts()">üîÑ Refresh</button>
            </div>

            <div class="contract-info" id="networkInfo">
                <strong>Network:</strong> <span id="networkName">Loading...</span><br>
                <strong>RPC URL:</strong> <span id="rpcUrl">Loading...</span>
            </div>

            <div class="contract-info" id="contractInfo">
                <strong>Status:</strong> <span style="color: blue;">Scanning for contracts...</span><br>
                <strong>Contracts Found:</strong> <span id="contractCount">0</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Minting Section -->
            <div class="card">
                <h2>üéØ Mint New Rug</h2>
                
                <div class="form-group">
                    <label for="textRows">Text Lines (one per line):</label>
                    <textarea id="textRows" placeholder="HELLO&#10;WORLD&#10;NFT" oninput="this.value = this.value.toUpperCase(); updateCharacterMap();"></textarea>
                    <small style="color: #666; font-size: 12px;">üí° Each text combination can only be minted once. Try "MAT", "WELCOME", "HELLO", etc.</small>
                    <div id="charCount" style="color: #888; font-size: 11px; margin-top: 4px;">0 lines, 0 characters</div>
                </div>

                <div class="form-group">
                    <label for="seed">Seed (number):</label>
                    <input type="number" id="seed" value="12345" placeholder="12345">
                </div>

                <div class="form-group">
                    <label for="palette">Color Palette (JSON):</label>
                    <textarea id="palette" placeholder='{"name":"Natural Dyes","colors":["#405BAA","#B33A3A","#D9A43B","#1F1E1D","#5A7A5A","#8C5832","#A48E7F","#FAF1E3"]}' rows="3">{"name":"Natural Dyes","colors":["#405BAA","#B33A3A","#D9A43B","#1F1E1D","#5A7A5A","#8C5832","#A48E7F","#FAF1E3"]}</textarea>
                </div>

                <div class="form-group">
                    <label for="stripeData">Stripe Data (JSON):</label>
                    <textarea id="stripeData" placeholder='[{"y":0,"height":68.19515249342658,"primaryColor":"#8C5832","secondaryColor":null,"weaveType":"solid","warpVariation":0.2523032833822072},{"y":68.19515249342658,"height":60.57278794585727,"primaryColor":"#405BAA","secondaryColor":null,"weaveType":"textured","warpVariation":0.290026696305722},{"y":128.76794043928385,"height":63.33571700495668,"primaryColor":"#5A7A5A","secondaryColor":null,"weaveType":"textured","warpVariation":0.4872925163246692},{"y":192.10365744424053,"height":53.3551848330535,"primaryColor":"#D9A43B","secondaryColor":null,"weaveType":"mixed","warpVariation":0.264055412914604},{"y":245.45884227729402,"height":26.21111069340259,"primaryColor":"#8C5832","secondaryColor":null,"weaveType":"textured","warpVariation":0.4787444246001542},{"y":271.6699529706966,"height":33.66517815273255,"primaryColor":"#A48E7F","secondaryColor":null,"weaveType":"solid","warpVariation":0.1734160046093166},{"y":305.33513112342916,"height":28.467843332327902,"primaryColor":"#405BAA","secondaryColor":null,"weaveType":"mixed","warpVariation":0.17198934191837906},{"y":333.80297445575707,"height":35.42853733757511,"primaryColor":"#D9A43B","secondaryColor":"#1F1E1D","weaveType":"solid","warpVariation":0.34202465508133173},{"y":369.2315117933322,"height":64.56409373320639,"primaryColor":"#D9A43B","secondaryColor":"#A48E7F","weaveType":"mixed","warpVariation":0.3359488218091429},{"y":433.79560552653857,"height":30.935605061240494,"primaryColor":"#8C5832","secondaryColor":"#5A7A5A","weaveType":"mixed","warpVariation":0.4187390603125095},{"y":464.73121058777906,"height":30.467415573075414,"primaryColor":"#FAF1E3","secondaryColor":"#8C5832","weaveType":"mixed","warpVariation":0.297656558919698},{"y":495.1986261608545,"height":71.31803949712776,"primaryColor":"#5A7A5A","secondaryColor":null,"weaveType":"solid","warpVariation":0.1779076951555908},{"y":566.5166656579822,"height":59.781514236237854,"primaryColor":"#FAF1E3","secondaryColor":null,"weaveType":"textured","warpVariation":0.1889693201519549},{"y":626.2981798942201,"height":58.780578861478716,"primaryColor":"#A48E7F","secondaryColor":null,"weaveType":"solid","warpVariation":0.4463496922515333},{"y":685.0787587556988,"height":61.152302387636155,"primaryColor":"#FAF1E3","secondaryColor":null,"weaveType":"solid","warpVariation":0.11557929040864111},{"y":746.231061143335,"height":41.0022804629989,"primaryColor":"#A48E7F","secondaryColor":null,"weaveType":"solid","warpVariation":0.1446685473434627},{"y":787.2333416063339,"height":26.13990316633135,"primaryColor":"#D9A43B","secondaryColor":null,"weaveType":"mixed","warpVariation":0.41371035808697343},{"y":813.3732447726652,"height":28.3406683197245,"primaryColor":"#A48E7F","secondaryColor":"#B33A3A","weaveType":"solid","warpVariation":0.3707780132070184},{"y":841.7139130923897,"height":21.8485507927835,"primaryColor":"#B33A3A","secondaryColor":null,"weaveType":"mixed","warpVariation":0.14659687876701355},{"y":863.5624638851732,"height":36.99597468134016,"primaryColor":"#B33A3A","secondaryColor":null,"weaveType":"textured","warpVariation":0.23930853065103294},{"y":900.5584385665134,"height":42.584983836859465,"primaryColor":"#8C5832","secondaryColor":null,"weaveType":"solid","warpVariation":0.1631861712783575},{"y":943.1434224033728,"height":68.52599811507389,"primaryColor":"#8C5832","secondaryColor":"#8C5832","weaveType":"mixed","warpVariation":0.1463954740203917},{"y":1011.6694205184467,"height":37.916444225702435,"primaryColor":"#8C5832","secondaryColor":"#1F1E1D","weaveType":"textured","warpVariation":0.14169594440609218},{"y":1049.5858647441491,"height":23.670224454253912,"primaryColor":"#D9A43B","secondaryColor":"#FAF1E3","weaveType":"mixed","warpVariation":0.16411913027986885},{"y":1073.256089198403,"height":78.71323970728554,"primaryColor":"#1F1E1D","secondaryColor":"#A48E7F","weaveType":"textured","warpVariation":0.17618615701794627},{"y":1151.9693289056886,"height":48.0306710943114,"primaryColor":"#405BAA","secondaryColor":"#405BAA","weaveType":"solid","warpVariation":0.3872393210418522}]' rows="8">[{"y":0,"height":68.19515249342658,"primaryColor":"#8C5832","secondaryColor":null,"weaveType":"solid","warpVariation":0.2523032833822072},{"y":68.19515249342658,"height":60.57278794585727,"primaryColor":"#405BAA","secondaryColor":null,"weaveType":"textured","warpVariation":0.290026696305722},{"y":128.76794043928385,"height":63.33571700495668,"primaryColor":"#5A7A5A","secondaryColor":null,"weaveType":"textured","warpVariation":0.4872925163246692},{"y":192.10365744424053,"height":53.3551848330535,"primaryColor":"#D9A43B","secondaryColor":null,"weaveType":"mixed","warpVariation":0.264055412914604},{"y":245.45884227729402,"height":26.21111069340259,"primaryColor":"#8C5832","secondaryColor":null,"weaveType":"textured","warpVariation":0.4787444246001542},{"y":271.6699529706966,"height":33.66517815273255,"primaryColor":"#A48E7F","secondaryColor":null,"weaveType":"solid","warpVariation":0.1734160046093166},{"y":305.33513112342916,"height":28.467843332327902,"primaryColor":"#405BAA","secondaryColor":null,"weaveType":"mixed","warpVariation":0.17198934191837906},{"y":333.80297445575707,"height":35.42853733757511,"primaryColor":"#D9A43B","secondaryColor":"#1F1E1D","weaveType":"solid","warpVariation":0.34202465508133173},{"y":369.2315117933322,"height":64.56409373320639,"primaryColor":"#D9A43B","secondaryColor":"#A48E7F","weaveType":"mixed","warpVariation":0.3359488218091429},{"y":433.79560552653857,"height":30.935605061240494,"primaryColor":"#8C5832","secondaryColor":"#5A7A5A","weaveType":"mixed","warpVariation":0.4187390603125095},{"y":464.73121058777906,"height":30.467415573075414,"primaryColor":"#FAF1E3","secondaryColor":"#8C5832","weaveType":"mixed","warpVariation":0.297656558919698},{"y":495.1986261608545,"height":71.31803949712776,"primaryColor":"#5A7A5A","secondaryColor":null,"weaveType":"solid","warpVariation":0.1779076951555908},{"y":566.5166656579822,"height":59.781514236237854,"primaryColor":"#FAF1E3","secondaryColor":null,"weaveType":"textured","warpVariation":0.1889693201519549},{"y":626.2981798942201,"height":58.780578861478716,"primaryColor":"#A48E7F","secondaryColor":null,"weaveType":"solid","warpVariation":0.4463496922515333},{"y":685.0787587556988,"height":61.152302387636155,"primaryColor":"#FAF1E3","secondaryColor":null,"weaveType":"solid","warpVariation":0.11557929040864111},{"y":746.231061143335,"height":41.0022804629989,"primaryColor":"#A48E7F","secondaryColor":null,"weaveType":"solid","warpVariation":0.1446685473434627},{"y":787.2333416063339,"height":26.13990316633135,"primaryColor":"#D9A43B","secondaryColor":null,"weaveType":"mixed","warpVariation":0.41371035808697343},{"y":813.3732447726652,"height":28.3406683197245,"primaryColor":"#A48E7F","secondaryColor":"#B33A3A","weaveType":"solid","warpVariation":0.3707780132070184},{"y":841.7139130923897,"height":21.8485507927835,"primaryColor":"#B33A3A","secondaryColor":null,"weaveType":"mixed","warpVariation":0.14659687876701355},{"y":863.5624638851732,"height":36.99597468134016,"primaryColor":"#B33A3A","secondaryColor":null,"weaveType":"textured","warpVariation":0.23930853065103294},{"y":900.5584385665134,"height":42.584983836859465,"primaryColor":"#8C5832","secondaryColor":null,"weaveType":"solid","warpVariation":0.1631861712783575},{"y":943.1434224033728,"height":68.52599811507389,"primaryColor":"#8C5832","secondaryColor":"#8C5832","weaveType":"mixed","warpVariation":0.1463954740203917},{"y":1011.6694205184467,"height":37.916444225702435,"primaryColor":"#8C5832","secondaryColor":"#1F1E1D","weaveType":"textured","warpVariation":0.14169594440609218},{"y":1049.5858647441491,"height":23.670224454253912,"primaryColor":"#D9A43B","secondaryColor":"#FAF1E3","weaveType":"mixed","warpVariation":0.16411913027986885},{"y":1073.256089198403,"height":78.71323970728554,"primaryColor":"#1F1E1D","secondaryColor":"#A48E7F","weaveType":"textured","warpVariation":0.17618615701794627},{"y":1151.9693289056886,"height":48.0306710943114,"primaryColor":"#405BAA","secondaryColor":"#405BAA","weaveType":"solid","warpVariation":0.3872393210418522}]</textarea>
                </div>

                <div class="form-group">
                    <label for="characterMap">Character Map (auto-generated from text):</label>
                    <textarea id="characterMap" placeholder='{"H":["01110","10001",...],"E":["11111","10000",...],...}' rows="3" readonly style="background: #f8f9fa; color: #6c757d;"></textarea>
                    <small style="color: #666; font-size: 12px;">üîÑ Automatically generated from your text input above. Only includes characters you actually use for gas efficiency.</small>
                </div>

                <div class="form-group">
                    <label for="warpThickness">Warp Thickness (1-5):</label>
                    <input type="number" id="warpThickness" value="3" min="1" max="5" step="1">
                </div>

                <div class="form-group">
                    <label for="complexity">Complexity (1-5):</label>
                    <input type="number" id="complexity" value="2" min="1" max="5" step="1">
                    <small style="color: #666; font-size: 12px;">üí° Determines the algorithmic complexity of your rug pattern</small>
                </div>

                <!-- Hidden fields for contract requirements -->
                <div class="form-group" style="display: none;">
                    <label for="paletteName">Palette Name:</label>
                    <input type="text" id="paletteName" value="Natural Dyes" readonly>
                </div>

                <div class="form-group" style="display: none;">
                    <label for="minifiedPalette">Minified Palette:</label>
                    <textarea id="minifiedPalette" readonly></textarea>
                </div>

                <div class="form-group" style="display: none;">
                    <label for="minifiedStripeData">Minified Stripe Data:</label>
                    <textarea id="minifiedStripeData" readonly></textarea>
                </div>

                <div class="form-group" style="display: none;">
                    <label for="filteredCharacterMap">Filtered Character Map:</label>
                    <textarea id="filteredCharacterMap" readonly></textarea>
                </div>

                <div class="form-group" style="display: none;">
                    <label for="characterCount">Character Count:</label>
                    <input type="number" id="characterCount" value="0" readonly>
                </div>

                <div class="form-group" style="display: none;">
                    <label for="stripeCount">Stripe Count:</label>
                    <input type="number" id="stripeCount" value="0" readonly>
                </div>

                <button class="btn" onclick="prepareMintData()">üîß Prepare Mint Data</button>
                <button class="btn" onclick="calculatePrice()">üí∞ Calculate Price</button>
                <button class="btn btn-secondary" onclick="showMintDebugInfo()">üîç Show Mint Parameters</button>
                <div id="priceDisplay" class="status hidden"></div>
                
                <!-- Mint Debug Info -->
                <div id="mintDebugInfo" class="status hidden">
                    <div class="error-technical-header">üîç Mint Parameters Debug</div>
                    <div class="error-technical-content">
                        <div><strong>textRows:</strong> <span id="debugTextRows">[]</span></div>
                        <div><strong>seed:</strong> <span id="debugSeed">0</span></div>
                        <div><strong>paletteName:</strong> <span id="debugPaletteName">N/A</span></div>
                        <div><strong>minifiedPalette:</strong> <span id="debugMinifiedPalette">N/A</span></div>
                        <div><strong>minifiedStripeData:</strong> <span id="debugMinifiedStripeData">N/A</span></div>
                        <div><strong>filteredCharacterMap:</strong> <span id="debugFilteredCharacterMap">N/A</span></div>
                        <div><strong>warpThickness:</strong> <span id="debugWarpThickness">3</span></div>
                        <div><strong>complexity:</strong> <span id="debugComplexity">2</span></div>
                        <div><strong>characterCount:</strong> <span id="debugCharacterCount">0</span></div>
                        <div><strong>stripeCount:</strong> <span id="debugStripeCount">0</span></div>
                    </div>
                </div>
                
                <!-- Config Status -->
                <div id="configStatus" class="status" style="margin-bottom: 10px; font-weight: bold;">
                    ‚è≥ Loading configuration...
                </div>

                <button class="btn btn-success" onclick="mintRug()" id="mintBtn" disabled>
                    üé® Mint Rug
                </button>
                <div id="mintStatus" class="status hidden"></div>

                <!-- Wallet Info Section -->
                <div id="walletInfo" class="wallet-info">
                    <div class="wallet-header">
                        <h3>üîë Wallet Info</h3>
                        <button onclick="refreshWalletInfo()" class="refresh-btn">üîÑ Refresh</button>
                    </div>
                    <div class="wallet-details">
                        <div class="wallet-item">
                            <strong>Network:</strong> <span id="networkName">Loading...</span>
                        </div>
                        <div class="wallet-item">
                            <strong>Address:</strong> <span id="walletAddress">Loading...</span>
                        </div>
                        <div class="wallet-item">
                            <strong>Balance:</strong> <span id="walletBalance">Loading...</span>
                        </div>
                        <div class="wallet-item">
                            <strong>RPC URL:</strong> <span id="rpcUrl">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NFT Display Section -->
            <div class="card">
                <h2>üñºÔ∏è View NFT</h2>
                
                <div class="form-group">
                    <label for="tokenId">Token ID:</label>
                    <input type="number" id="tokenId" value="1" min="1">
                    <small style="color: #666; font-size: 12px;">üí° ERC721 tokens start from ID 1, not 0</small>
                </div>

                <button class="btn" onclick="loadNFT()">üîç Load NFT</button>
                <button class="btn btn-secondary" onclick="loadLatestNFT()">üìà Load Latest</button>

                <div id="nftDisplay" class="nft-display">
                    <p style="text-align: center; color: #666;">Enter a Token ID and click "Load NFT" to view</p>
                </div>

                <div id="tokenInfo" class="token-info hidden">
                    <h3>Token Information</h3>
                    <div id="tokenDetails"></div>
                </div>

                <div id="metadataInfo" class="metadata-info hidden">
                    <h3>üìã OpenSea Metadata</h3>
                    
                    <div class="metadata-section">
                        <h4>üé® Traits & Attributes</h4>
                        <div id="traitsDisplay" class="traits-display"></div>
                    </div>
                    
                    <div class="metadata-section">
                        <h4>üìÑ JSON Metadata (for indexers like OpenSea)</h4>
                        <div id="metadataJson" class="metadata-json"></div>
                        <button class="btn btn-small" onclick="copyMetadata()">üìã Copy Metadata</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Interaction Section -->
        <div class="card">
            <h2>‚öôÔ∏è Contract Interactions</h2>
            
            <div class="grid-2">
                <div>
                    <h3>üßπ Clean Rug</h3>
                    <div class="form-group">
                        <label for="cleanTokenId">Token ID to Clean:</label>
                        <input type="number" id="cleanTokenId" value="1" min="1">
                        <small style="color: #666; font-size: 12px;">üí° Must own this token</small>
                    </div>
                    <button class="btn btn-secondary" onclick="cleanRug()">Clean Rug</button>
                    <div id="cleanStatus" class="status hidden"></div>
                </div>

                <div>
                    <h3>üìä Contract Info</h3>
                    <button class="btn" onclick="getContractInfo()">Get Contract Info</button>
                    <div id="contractStatus" class="status hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Network configurations
        // Load configuration from .env via API (secure server-side access)
        async function loadConfigFromAPI() {
            console.log('üîÑ Loading config from API...');

            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const config = await response.json();
                window.MINT_UI_CONFIG = config;

                // Update global variables with loaded config
                NETWORKS.local.privateKey = config.PRIVATE_KEYS.local;
                NETWORKS.testnet.privateKey = config.PRIVATE_KEYS.testnet;
                NETWORKS.local.contract = config.CONTRACTS.local;
                NETWORKS.testnet.contract = config.CONTRACTS.testnet;

                // Update current network variables
                PRIVATE_KEY = NETWORKS[currentNetwork].privateKey;
                CONTRACT_ADDRESS = NETWORKS[currentNetwork].contract || CONTRACT_ADDRESS;
                RPC_URL = NETWORKS[currentNetwork].rpcUrl;

                console.log('üîÑ NETWORKS updated with config:');
                console.log('Local private key:', NETWORKS.local.privateKey.substring(0, 10) + '...');
                console.log('Testnet private key:', NETWORKS.testnet.privateKey.substring(0, 10) + '...');
                console.log('Current PRIVATE_KEY:', PRIVATE_KEY.substring(0, 10) + '...');

                configLoaded = true;
                console.log('‚úÖ Config loaded from API:', config);
                console.log('‚úÖ Updated PRIVATE_KEY:', PRIVATE_KEY.substring(0, 10) + '...');

                // Update UI to show config is ready
                updateConfigStatus(true);

                // Refresh current network config in case user was already on testnet
                setTimeout(() => {
                    refreshNetworkConfig();
                }, 100);

                return true;
            } catch (error) {
                console.error('‚ùå Failed to load config from API:', error);
                return false;
            }
        }

        function checkConfigLoaded() {
            console.log('üîç Checking config...');
            console.log('window.MINT_UI_CONFIG:', window.MINT_UI_CONFIG);

            if (!window.MINT_UI_CONFIG) {
                console.error('‚ùå Config not loaded! API server may not be running.');
                console.log('Make sure to run: npm run config-server');
                return false;
            }
            if (!window.MINT_UI_CONFIG.PRIVATE_KEYS) {
                console.error('‚ùå Private keys not found in config!');
                console.log('Check your .env file has PRIVATE_KEY and ONCHAIN_RUGS_PRIVATE_KEY');
                return false;
            }
            console.log('‚úÖ Config loaded successfully:', window.MINT_UI_CONFIG);
            return true;
        }

        // Manual test function for debugging
        window.testConfig = async function() {
            console.log('üß™ Manual config test:');
            const success = await loadConfigFromAPI();
            if (success) {
                return checkConfigLoaded();
            }
            return false;
        };

        // Manual function to refresh network config (useful after config loads)
        window.refreshNetworkConfig = function() {
            console.log('üîÑ Refreshing network configuration...');
            PRIVATE_KEY = NETWORKS[currentNetwork].privateKey;
            CONTRACT_ADDRESS = NETWORKS[currentNetwork].contract || CONTRACT_ADDRESS;
            RPC_URL = NETWORKS[currentNetwork].rpcUrl;
            console.log('‚úÖ Network config refreshed:');
            console.log('PRIVATE_KEY:', PRIVATE_KEY.substring(0, 10) + '...');
            console.log('CONTRACT_ADDRESS:', CONTRACT_ADDRESS);
            console.log('RPC_URL:', RPC_URL);
        };

        // Fallback config for development
        function loadFallbackConfig() {
            console.log('üîÑ Loading fallback config (for development only)...');
            window.MINT_UI_CONFIG = {
                PRIVATE_KEYS: {
                    local: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80",
                    testnet: "YOUR_TESTNET_PRIVATE_KEY_HERE"
                },
                CONTRACTS: {
                    local: "0x5FbDB2315678afecb367f032d93F642f64180aa3",
                        testnet: "0xCCc8aBA355E37FDA0D680288F531840552C27342"
                }
            };

            // Update global variables with fallback config
            NETWORKS.local.privateKey = window.MINT_UI_CONFIG.PRIVATE_KEYS.local;
            NETWORKS.testnet.privateKey = window.MINT_UI_CONFIG.PRIVATE_KEYS.testnet;
            NETWORKS.local.contract = window.MINT_UI_CONFIG.CONTRACTS.local;
            NETWORKS.testnet.contract = window.MINT_UI_CONFIG.CONTRACTS.testnet;

            // Update current network variables
            PRIVATE_KEY = NETWORKS[currentNetwork].privateKey;
            CONTRACT_ADDRESS = NETWORKS[currentNetwork].contract || CONTRACT_ADDRESS;
            RPC_URL = NETWORKS[currentNetwork].rpcUrl;

            console.log('üîÑ Fallback NETWORKS updated:');
            console.log('Local private key:', NETWORKS.local.privateKey.substring(0, 10) + '...');
            console.log('Testnet private key:', NETWORKS.testnet.privateKey.substring(0, 10) + '...');
            console.log('Current PRIVATE_KEY:', PRIVATE_KEY.substring(0, 10) + '...');

            configLoaded = true;

            // Update UI to show config is ready
            updateConfigStatus(true);
            console.log('‚úÖ Fallback config loaded');
        }

        // Function to update config status in UI
        function updateConfigStatus(loaded) {
            const configStatus = document.getElementById('configStatus');
            const mintBtn = document.getElementById('mintBtn');

            if (configStatus) {
                if (loaded) {
                    configStatus.innerHTML = '‚úÖ Configuration loaded from .env';
                    configStatus.style.color = 'green';
                    if (mintBtn) mintBtn.disabled = false;
                } else {
                    configStatus.innerHTML = '‚è≥ Loading configuration...';
                    configStatus.style.color = 'orange';
                    if (mintBtn) mintBtn.disabled = true;
                }
            }
        }

        const NETWORKS = {
            local: {
                name: 'Local (Anvil)',
                rpcUrl: 'http://localhost:8545',
                privateKey: window.MINT_UI_CONFIG?.PRIVATE_KEYS?.local || 'CONFIG_NOT_LOADED',
                chainId: 31337
            },
            testnet: {
                name: 'Shape Sepolia Testnet',
                rpcUrl: 'https://sepolia.shape.network',
                privateKey: window.MINT_UI_CONFIG?.PRIVATE_KEYS?.testnet || 'CONFIG_NOT_LOADED',
                chainId: 11011
            }
        };
        
        // Current network configuration
        let currentNetwork = 'local';
        let CONTRACT_ADDRESS = '';
        let RPC_URL = NETWORKS[currentNetwork].rpcUrl;
        let PRIVATE_KEY = NETWORKS[currentNetwork].privateKey;
        let configLoaded = false;
        let availableContracts = [];

        // Function to scan for deployed contracts
        async function scanForContracts() {
            try {
                console.log('Scanning for deployed contracts...');
                availableContracts = [];

                // Scan for deployed contracts dynamically
                const mockContracts = [];

                // For local network, use the configured contract address
                if (currentNetwork === 'local') {
                    const localContract = window.MINT_UI_CONFIG?.CONTRACTS?.local;
                    if (localContract) {
                        mockContracts.push({
                            address: localContract,
                            name: 'OnchainRugs',
                            deployedAt: new Date(Date.now() - 30000), // 30 seconds ago
                            network: 'local',
                            hasCustomMinting: true,
                            description: 'Latest local deployment with full algorithm'
                        });
                    }
                    // Add fallback local address
                    mockContracts.push({
                        address: '0x5FbDB2315678afecb367f032d93F642f64180aa3',
                        name: 'OnchainRugs',
                        deployedAt: new Date(Date.now() - 180000), // 3 minutes ago
                        network: 'local',
                        hasCustomMinting: true,
                        description: 'Fallback local deployment'
                    });
                }

                // For testnet, use the configured contract address
                if (currentNetwork === 'testnet') {
                    const testnetContract = window.MINT_UI_CONFIG?.CONTRACTS?.testnet;
                    if (testnetContract) {
                    mockContracts.push({
                            address: testnetContract,
                            name: 'OnchainRugs',
                            deployedAt: new Date(Date.now() - 300000), // 5 minutes ago
                            network: 'testnet',
                            hasCustomMinting: true,
                            description: 'Latest Shape Sepolia deployment'
                        });
                    }
                    // Add fallback testnet address
                    mockContracts.push({
                        address: '0x38b7F32Bfb88f0c513E0e52257277057F2375010',
                        name: 'OnchainRugs',
                        deployedAt: new Date(Date.now() - 7200000), // 2 hours ago
                        network: 'testnet',
                        hasCustomMinting: true,
                        description: 'Fallback Shape Sepolia deployment'
                    });
                }

                // In production, replace this with actual contract discovery
                // You could scan blockchain events, use a subgraph, or maintain a registry

                availableContracts = mockContracts.filter(c => c.network === currentNetwork);
                availableContracts.sort((a, b) => b.deployedAt - a.deployedAt); // Latest first

                console.log(`Found ${availableContracts.length} contracts for ${currentNetwork} network:`, availableContracts);
                return availableContracts;

            } catch (error) {
                console.error('Error scanning for contracts:', error);
                return [];
            }
        }

        // Function to update contract selector UI
        function updateContractSelector() {
            const selector = document.getElementById('contractSelector');
            const contractInfo = document.getElementById('contractInfo');
            const contractCount = document.getElementById('contractCount');

            if (availableContracts.length === 0) {
                selector.innerHTML = '<option value="">No contracts found</option>';
                contractInfo.innerHTML = '<strong>Status:</strong> <span style="color: red;">No contracts available</span>';
                if (contractCount) contractCount.textContent = '0';
                return;
            }

            let optionsHtml = '<option value="">Select a contract...</option>';
            availableContracts.forEach((contract, index) => {
                const isLatest = index === 0;
                const timeAgo = getTimeAgo(contract.deployedAt);
                optionsHtml += `<option value="${contract.address}" ${isLatest ? 'selected' : ''}>
                    ${contract.name} - ${timeAgo} ${isLatest ? '(Latest)' : ''}
                </option>`;
            });

            selector.innerHTML = optionsHtml;

            // Update contract count
            if (contractCount) contractCount.textContent = availableContracts.length.toString();

            // Auto-select latest contract
            if (availableContracts.length > 0) {
                CONTRACT_ADDRESS = availableContracts[0].address;
                updateContractDisplay();
                console.log(`‚úÖ Auto-selected contract: ${CONTRACT_ADDRESS}`);
            }
        }

        // Function to get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        // Function to update contract display
        function updateContractDisplay() {
            const contractInfo = document.getElementById('contractInfo');
            const selectedContract = availableContracts.find(c => c.address === CONTRACT_ADDRESS);

            if (selectedContract) {
                contractInfo.innerHTML = `
                    <strong>Contract:</strong> ${selectedContract.name}<br>
                    <strong>Address:</strong> ${selectedContract.address}<br>
                    <strong>Deployed:</strong> ${selectedContract.deployedAt.toLocaleString()}<br>
                    <strong>Features:</strong> ${selectedContract.hasCustomMinting ? 'Custom Parameters' : 'Auto-Generated'}<br>
                    <strong>Description:</strong> ${selectedContract.description}
                `;
            } else {
                contractInfo.innerHTML = '<strong>Status:</strong> <span style="color: orange;">Please select a contract</span>';
            }
        }

        // Contract ABI for OnchainRugs
        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType": "string[]", "name": "textRows", "type": "string[]"},
                    {"internalType": "uint256", "name": "seed", "type": "uint256"},
                    {"internalType": "string", "name": "paletteName", "type": "string"},
                    {"internalType": "string", "name": "minifiedStripeData", "type": "string"},
                    {"internalType": "string", "name": "minifiedPalette", "type": "string"},
                    {"internalType": "string", "name": "filteredCharacterMap", "type": "string"},
                    {"internalType": "uint8", "name": "warpThickness", "type": "uint8"},
                    {"internalType": "uint8", "name": "complexity", "type": "uint8"},
                    {"internalType": "uint256", "name": "characterCount", "type": "uint256"},
                    {"internalType": "uint256", "name": "stripeCount", "type": "uint256"}
                ],
                "name": "mintRug",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "textLines", "type": "uint256"}],
                "name": "getMintPrice",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "tokenURI",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "ownerOf",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "cleanRug",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint8", "name": "dl", "type": "uint8"}],
                "name": "getCleaningCost",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "launderRug",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "reduceTextureLevel",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "launderOnSale",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "calculateAgingState",
                "outputs": [
                    {"internalType": "uint8", "name": "", "type": "uint8"},
                    {"internalType": "uint8", "name": "", "type": "uint8"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "name",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSupply",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "maxSupply",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "basePrice",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "level1CleaningCost",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "level2CleaningCost",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "textureReductionCost",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "fullLaunderingCost",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "royaltyPercentage",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Utility functions
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `status ${type}`;
            element.classList.remove('hidden');
        }

        function hideStatus(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function showLoading(buttonId) {
            const btn = document.getElementById(buttonId);
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Processing...';
        }

        function hideLoading(buttonId, originalText) {
            const btn = document.getElementById(buttonId);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }


        // Copy error details to clipboard
        function copyErrorDetails(errorText) {
            navigator.clipboard.writeText(errorText).then(function() {
                // Show temporary success message
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#6c757d';
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = errorText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#6c757d';
                }, 2000);
            });
        }

        // Initialize character map on page load
        function initializeCharacterMap() {
            updateCharacterMap();
        }

        // Display wallet information
        async function updateWalletInfo() {
            try {
                if (typeof ethers === 'undefined') {
                    console.log('Ethers not loaded yet');
                    return;
                }

                const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
                const wallet = new ethers.Wallet(PRIVATE_KEY, provider);

                // Update network name
                document.getElementById('networkName').textContent = NETWORKS[currentNetwork].name;

                // Update wallet address
                document.getElementById('walletAddress').textContent = wallet.address;

                // Update RPC URL
                document.getElementById('rpcUrl').textContent = RPC_URL;

                // Get and display balance
                const balance = await wallet.getBalance();
                const balanceEth = ethers.utils.formatEther(balance);
                document.getElementById('walletBalance').textContent = `${parseFloat(balanceEth).toFixed(4)} ETH`;

                // Also get contract stats if available
                try {
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                    const totalSupply = await contract.totalSupply();
                    const maxSupply = await contract.maxSupply();

                    // Update a hidden element with this info for error messages
                    let contractStats = document.getElementById('contractStats');
                    if (!contractStats) {
                        contractStats = document.createElement('div');
                        contractStats.id = 'contractStats';
                        contractStats.style.display = 'none';
                        document.body.appendChild(contractStats);
                    }
                    contractStats.textContent = JSON.stringify({ totalSupply: totalSupply.toString(), maxSupply: maxSupply.toString() });
                } catch (e) {
                    console.log('Could not fetch contract stats:', e.message);
                }

                console.log(`Wallet Info Updated: ${wallet.address} on ${NETWORKS[currentNetwork].name}`);

            } catch (error) {
                console.error('Error updating wallet info:', error);
                document.getElementById('walletAddress').textContent = 'Error loading';
                document.getElementById('walletBalance').textContent = 'Error loading';
                document.getElementById('rpcUrl').textContent = 'Error loading';
            }
        }

        // Refresh wallet info manually
        async function refreshWalletInfo() {
            console.log('Manually refreshing wallet info...');
            await updateWalletInfo();
        }

        // Simple function to clear NFT display
        function clearNFTDisplay() {
            const nftDisplay = document.getElementById('nftDisplay');
            if (nftDisplay) {
                nftDisplay.innerHTML = '<p style="text-align: center; color: #666;">Enter a Token ID and click "Load NFT" to view</p>';
            }
        }

        // Clean and simple NFT loader
        async function loadNFT() {
            try {
                // Check if ethers is loaded
                if (typeof ethers === 'undefined') {
                    showStatus('mintStatus', 'Ethers.js not loaded. Please refresh the page.', 'error');
                    return;
                }

                const tokenId = document.getElementById('tokenId').value;

                if (!tokenId || tokenId < 1) {
                    showStatus('mintStatus', 'Please enter a valid token ID (minimum 1)', 'error');
                    return;
                }

                showStatus('mintStatus', 'Loading NFT...', 'info');

                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, new ethers.providers.JsonRpcProvider(RPC_URL));

                // Check if token exists
                await contract.ownerOf(tokenId);

                // Get token URI
                const tokenURI = await contract.tokenURI(tokenId);

                // Parse the metadata
                const base64Json = tokenURI.split('data:application/json;base64,')[1];
                const metadata = JSON.parse(atob(base64Json));

                // Get the HTML from animation_url (OpenSea standard for interactive NFTs)
                const imageUrl = metadata.animation_url;
                const base64Html = imageUrl.split('data:text/html;base64,')[1];
                const decodedHtml = atob(base64Html);

                // Clear previous display
                clearNFTDisplay();

                // Create iframe with the NFT
                const nftDisplay = document.getElementById('nftDisplay');
                const iframeId = `nft-iframe-${tokenId}`;
                const iframeHtml = `<iframe id="${iframeId}" srcdoc="${decodedHtml.replace(/"/g, '&quot;')}" style="width: 100%; height: 100%; border: none; border-radius: 8px;"></iframe>`;

                nftDisplay.innerHTML = iframeHtml;

                showStatus('mintStatus', `‚úÖ NFT #${tokenId} loaded successfully!`, 'success');

            } catch (error) {
                console.error('Load NFT error:', error);
                showStatus('mintStatus', `‚ùå Failed to load NFT: ${error.message}`, 'error');
                clearNFTDisplay();
            }
        }

        // Full character map for text rendering
        const fullCharacterMap = {
            'A': ["01110","10001","10001","11111","10001","10001","10001"],
            'B': ["11110","10001","10001","11110","10001","10001","11110"],
            'C': ["01111","10000","10000","10000","10000","10000","01111"],
            'D': ["11110","10001","10001","10001","10001","10001","11110"],
            'E': ["11111","10000","10000","11110","10000","10000","11111"],
            'F': ["11111","10000","10000","11110","10000","10000","10000"],
            'G': ["01111","10000","10000","10011","10001","10001","01111"],
            'H': ["10001","10001","10001","11111","10001","10001","10001"],
            'I': ["11111","00100","00100","00100","00100","00100","11111"],
            'J': ["11111","00001","00001","00001","00001","10001","01110"],
            'K': ["10001","10010","10100","11000","10100","10010","10001"],
            'L': ["10000","10000","10000","10000","10000","10000","11111"],
            'M': ["10001","11011","10101","10001","10001","10001","10001"],
            'N': ["10001","11001","10101","10011","10001","10001","10001"],
            'O': ["01110","10001","10001","10001","10001","10001","01110"],
            'P': ["11110","10001","10001","11110","10000","10000","10000"],
            'Q': ["01110","10001","10001","10001","10101","10010","01101"],
            'R': ["11110","10001","10001","11110","10100","10010","10001"],
            'S': ["01111","10000","10000","01110","00001","00001","11110"],
            'T': ["11111","00100","00100","00100","00100","00100","00100"],
            'U': ["10001","10001","10001","10001","10001","10001","01110"],
            'V': ["10001","10001","10001","10001","10001","01010","00100"],
            'W': ["10001","10001","10001","10001","10101","11011","10001"],
            'X': ["10001","10001","01010","00100","01010","10001","10001"],
            'Y': ["10001","10001","01010","00100","00100","00100","00100"],
            'Z': ["11111","00001","00010","00100","01000","10000","11111"],
            ' ': ["00000","00000","00000","00000","00000","00000","00000"],
            '0': ["01110","10001","10011","10101","11001","10001","01110"],
            '1': ["00100","01100","00100","00100","00100","00100","01110"],
            '2': ["01110","10001","00001","00010","00100","01000","11111"],
            '3': ["11110","00001","00001","01110","00001","00001","11110"],
            '4': ["00010","00110","01010","10010","11111","00010","00010"],
            '5': ["11111","10000","10000","11110","00001","00001","11110"],
            '6': ["01110","10000","10000","11110","10001","10001","01110"],
            '7': ["11111","00001","00010","00100","01000","01000","01000"],
            '8': ["01110","10001","10001","01110","10001","10001","01110"],
            '9': ["01110","10001","10001","01111","00001","00001","01110"]
        };

        // Generate character map from text input
        function generateCharacterMap(textRows) {
            if (!textRows || textRows.length === 0) {
                return "{}";
            }

            const usedChars = new Set();

            // Collect all unique characters from text rows
            textRows.forEach(row => {
                if (row && row.trim()) {
                    for (let char of row.toUpperCase()) {
                        usedChars.add(char);
                    }
                }
            });

            // Always include space character
            usedChars.add(' ');

            // Create filtered character map
            const filteredMap = {};
            usedChars.forEach(char => {
                if (fullCharacterMap[char]) {
                    filteredMap[char] = fullCharacterMap[char];
                }
            });

            return JSON.stringify(filteredMap);
        }

        // Update character map when text changes
        function updateCharacterMap() {
            const textRows = document.getElementById('textRows').value
                .split('\n')
                .filter(line => line.trim())
                .map(line => line.toUpperCase());

            const characterMap = generateCharacterMap(textRows);
            document.getElementById('characterMap').value = characterMap;

            // Update character count display
            const charCount = textRows.join('').length;
            document.getElementById('charCount').textContent = `${textRows.length} lines, ${charCount} characters`;

            // Update hidden fields
            updateHiddenFields();
        }

        // Prepare all mint data for the contract
        function prepareMintData() {
            try {
                const textRows = document.getElementById('textRows').value
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => line.toUpperCase());

                if (textRows.length === 0) {
                    showStatus('mintStatus', 'Please enter at least one text line', 'error');
                    return;
                }

                // Parse palette data
                const paletteJson = JSON.parse(document.getElementById('palette').value);
                const paletteName = paletteJson.name || 'Custom Palette';

                // Parse stripe data
                const stripeData = JSON.parse(document.getElementById('stripeData').value);

                // Generate filtered character map
                const filteredCharacterMap = generateCharacterMap(textRows);

                // Update all hidden fields
                document.getElementById('paletteName').value = paletteName;
                document.getElementById('minifiedPalette').value = JSON.stringify(paletteJson);
                document.getElementById('minifiedStripeData').value = JSON.stringify(stripeData);
                document.getElementById('filteredCharacterMap').value = filteredCharacterMap;
                document.getElementById('characterCount').value = textRows.join('').length;
                document.getElementById('stripeCount').value = stripeData.length;

                showStatus('mintStatus', '‚úÖ Mint data prepared successfully! You can now mint your rug.', 'success');

            } catch (error) {
                console.error('Error preparing mint data:', error);
                showStatus('mintStatus', `‚ùå Error preparing mint data: ${error.message}`, 'error');
            }
        }

        // Update hidden fields automatically
        function updateHiddenFields() {
            try {
                const textRows = document.getElementById('textRows').value
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => line.toUpperCase());

                if (textRows.length === 0) return;

                // Parse palette data
                const paletteJson = JSON.parse(document.getElementById('palette').value || '{}');
                const paletteName = paletteJson.name || 'Custom Palette';

                // Parse stripe data
                const stripeData = JSON.parse(document.getElementById('stripeData').value || '[]');

                // Generate filtered character map
                const filteredCharacterMap = generateCharacterMap(textRows);

                // Update hidden fields
                document.getElementById('paletteName').value = paletteName;
                document.getElementById('minifiedPalette').value = JSON.stringify(paletteJson);
                document.getElementById('minifiedStripeData').value = JSON.stringify(stripeData);
                document.getElementById('filteredCharacterMap').value = filteredCharacterMap;
                document.getElementById('characterCount').value = textRows.join('').length;
                document.getElementById('stripeCount').value = stripeData.length;

            } catch (error) {
                console.error('Error updating hidden fields:', error);
            }
        }

        // Show mint parameters for debugging
        function showMintDebugInfo() {
            try {
                const textRows = document.getElementById('textRows').value
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => line.toUpperCase());

                if (textRows.length === 0) {
                    showStatus('mintStatus', 'Please enter at least one text line first', 'error');
                    return;
                }

                // Prepare data first
                prepareMintData();

                // Update debug display
                document.getElementById('debugTextRows').textContent = JSON.stringify(textRows);
                document.getElementById('debugSeed').textContent = document.getElementById('seed').value;
                document.getElementById('debugPaletteName').textContent = document.getElementById('paletteName').value;
                document.getElementById('debugMinifiedPalette').textContent = document.getElementById('minifiedPalette').value.substring(0, 50) + '...';
                document.getElementById('debugMinifiedStripeData').textContent = document.getElementById('minifiedStripeData').value.substring(0, 50) + '...';
                document.getElementById('debugFilteredCharacterMap').textContent = document.getElementById('filteredCharacterMap').value.substring(0, 50) + '...';
                document.getElementById('debugWarpThickness').textContent = document.getElementById('warpThickness').value;
                document.getElementById('debugComplexity').textContent = document.getElementById('complexity').value;
                document.getElementById('debugCharacterCount').textContent = document.getElementById('characterCount').value;
                document.getElementById('debugStripeCount').textContent = document.getElementById('stripeCount').value;

                // Show the debug info
                document.getElementById('mintDebugInfo').classList.remove('hidden');

            } catch (error) {
                console.error('Error showing debug info:', error);
                showStatus('mintStatus', `‚ùå Error showing debug info: ${error.message}`, 'error');
            }
        }

        // Calculate minting price
        async function calculatePrice() {
            try {
                // Check if ethers is loaded
                if (typeof ethers === 'undefined') {
                    showStatus('priceDisplay', 'Ethers.js not loaded. Please refresh the page.', 'error');
                    return;
                }

                const textRows = document.getElementById('textRows').value.split('\n').filter(line => line.trim()).map(line => line.toUpperCase());
                
                if (textRows.length === 0) {
                    showStatus('priceDisplay', 'Please enter at least one text line', 'error');
                    return;
                }

                if (textRows.length > 5) {
                    showStatus('priceDisplay', 'Maximum 5 text lines allowed', 'error');
                    return;
                }

                showLoading('mintBtn');
                showStatus('priceDisplay', 'Calculating price...', 'info');
                
                // Create provider and contract instance
                const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                
                // Test connection first
                try {
                    const network = await provider.getNetwork();
                    console.log('Connected to network:', network.chainId.toString());
                } catch (networkError) {
                    throw new Error(`Network connection failed: ${networkError.message}`);
                }
                
                // Calculate price using getMintPrice
                const price = await contract.getMintPrice(textRows.length);
                const priceEth = ethers.utils.formatEther(price);
                
                showStatus('priceDisplay', `Minting Price: ${priceEth} ETH for ${textRows.length} line${textRows.length > 1 ? 's' : ''}`, 'success');
                hideLoading('mintBtn', 'üé® Mint Rug');
                
            } catch (error) {
                console.error('Calculate price error:', error);
                let errorMessage = error.message;

                // Make price calculation errors more user-friendly
                if (errorMessage.includes('call revert exception')) {
                    errorMessage = '‚ùå Cannot calculate price. Contract might be paused or there\'s a network issue.';
                } else if (errorMessage.includes('network')) {
                    errorMessage = '‚ùå Network error. Please check your connection and try again.';
                } else {
                    errorMessage = '‚ùå Error calculating price. Please try again.';
                }

                showStatus('priceDisplay', errorMessage, 'error');
                hideLoading('mintBtn', 'üé® Mint Rug');
            }
        }

        // Mint a new rug
        async function mintRug() {
            try {
                // Check if ethers is loaded
                if (typeof ethers === 'undefined') {
                    showStatus('mintStatus', 'Ethers.js not loaded. Please refresh the page.', 'error');
                    return;
                }

                // Prepare mint data first
                prepareMintData();

                const textRows = document.getElementById('textRows').value.split('\n').filter(line => line.trim()).map(line => line.toUpperCase());
                const seed = document.getElementById('seed').value;
                const paletteName = document.getElementById('paletteName').value;
                const minifiedPalette = document.getElementById('minifiedPalette').value;
                const minifiedStripeData = document.getElementById('minifiedStripeData').value;
                const filteredCharacterMap = document.getElementById('filteredCharacterMap').value;
                const warpThickness = document.getElementById('warpThickness').value;
                const complexity = document.getElementById('complexity').value;
                const characterCount = document.getElementById('characterCount').value;
                const stripeCount = document.getElementById('stripeCount').value;

                // Validate inputs
                if (textRows.length === 0) {
                    showStatus('mintStatus', 'Please enter at least one text line', 'error');
                    return;
                }

                if (textRows.length > 5) {
                    showStatus('mintStatus', 'Maximum 5 text lines allowed', 'error');
                    return;
                }

                if (!palette || !stripeData || !warpThickness) {
                    showStatus('mintStatus', 'Please fill in all fields (palette, stripe data, warp thickness)', 'error');
                    return;
                }

                // Check for common duplicate texts
                const textString = textRows.join('').toLowerCase().trim();
                const commonTexts = ['welcome', 'hello', 'hi', 'mat', 'rug', 'test', 'demo', 'shape', 'nft', 'art', 'home', 'door'];

                if (commonTexts.some(common => textString.includes(common) && textString.length < 20)) {
                    showStatus('mintStatus', '‚ö†Ô∏è This text might already be minted. Consider using more unique text to avoid duplication errors.', 'warning');
                    // Don't return, just warn the user
                }

                showLoading('mintBtn');
                showStatus('mintStatus', 'Minting rug...', 'info');

                // Check if config is loaded
                if (!configLoaded || PRIVATE_KEY === 'CONFIG_NOT_LOADED' || PRIVATE_KEY === 'YOUR_TESTNET_PRIVATE_KEY_HERE') {
                    const errorMsg = !configLoaded
                        ? 'Configuration not loaded yet. Please wait for page to fully load.'
                        : 'Private key not configured. Please check your .env file and restart the config server.';
                    showStatus('mintStatus', errorMsg, 'error');
                    hideLoading('mintBtn');
                    console.error('‚ùå Config not loaded:', { configLoaded, PRIVATE_KEY });
                    return;
                }

                // Create wallet and contract instance
                const wallet = new ethers.Wallet(PRIVATE_KEY, new ethers.providers.JsonRpcProvider(RPC_URL));
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, wallet);

                // Calculate price using getMintPrice
                const price = await contract.getMintPrice(textRows.length);

                // Debug: Check wallet balance
                const balance = await wallet.getBalance();
                console.log('Wallet balance:', ethers.utils.formatEther(balance), 'ETH');
                console.log('Mint price:', ethers.utils.formatEther(price), 'ETH');
                console.log('Current network:', currentNetwork);
                console.log('Contract address:', CONTRACT_ADDRESS);
                
                // Estimate gas for the transaction
                const gasEstimate = await contract.estimateGas.mintRug(
                    textRows,
                    seed === '' ? 0 : parseInt(seed),
                    paletteName,
                    minifiedStripeData,
                    minifiedPalette,
                    filteredCharacterMap,
                    parseInt(warpThickness),
                    parseInt(complexity),
                    parseInt(characterCount),
                    parseInt(stripeCount),
                    { value: price }
                );
                
                // Add 20% buffer to gas estimate
                const gasLimit = gasEstimate.mul(120).div(100);
                
                console.log('Gas estimate:', gasEstimate.toString());
                console.log('Gas limit with buffer:', gasLimit.toString());
                console.log('Minting price:', ethers.utils.formatEther(price), 'ETH');
                
                // Mint the rug with correct parameters
                const tx = await contract.mintRug(
                    textRows,
                    seed === '' ? 0 : parseInt(seed),
                    paletteName,
                    minifiedStripeData,
                    minifiedPalette,
                    filteredCharacterMap,
                    parseInt(warpThickness),
                    parseInt(complexity),
                    parseInt(characterCount),
                    parseInt(stripeCount),
                    { 
                        value: price,
                        gasLimit: gasLimit
                    }
                );

                showStatus('mintStatus', `Transaction sent: ${tx.hash}`, 'info');
                
                // Wait for confirmation
                const receipt = await tx.wait();
                
                if (receipt.status === 1) {
                    // Find the newly minted token ID by checking recent tokens
                    let tokenId = 1; // Start from 1 since ERC721 tokens start at ID 1
                    let foundToken = false;

                    // Check up to 20 recent token IDs to find the newly minted one
                    for (let i = 1; i <= 20 && !foundToken; i++) {
                        try {
                            const owner = await contract.ownerOf(i);
                            // Check if this token is owned by our wallet
                            if (owner && owner !== '0x0000000000000000000000000000000000000000') {
                                // Get the total supply to find the highest token ID
                                try {
                                    const totalSupply = await contract._totalSupply();
                                    tokenId = totalSupply.toString();
                                    foundToken = true;
                                } catch (supplyError) {
                                    // Fallback: assume the highest checked token is the one we want
                                    tokenId = i.toString();
                                    foundToken = true;
                                }
                            }
                        } catch (error) {
                            // Token doesn't exist, continue checking
                            continue;
                        }
                    }

                    if (foundToken) {
                        showStatus('mintStatus', `‚úÖ Rug minted successfully! Token ID: ${tokenId}`, 'success');
                    } else {
                        showStatus('mintStatus', `‚úÖ Rug minted successfully! Check contract for token ID.`, 'success');
                    }
                    
                    // Auto-load the new NFT
                    document.getElementById('tokenId').value = tokenId.toString();
                    setTimeout(() => loadNFT(), 1000);
                } else {
                    showStatus('mintStatus', '‚ùå Transaction failed', 'error');
                }
                
                hideLoading('mintBtn', 'üé® Mint Rug');
                
            } catch (error) {
                console.error('Minting error:', error);

                // Always preserve the complete technical error for debugging
                const fullTechnicalError = {
                    message: error.message || 'No message',
                    stack: error.stack || 'No stack trace',
                    name: error.name || 'Unknown Error',
                    code: error.code || 'No code',
                    data: error.data || 'No data',
                    toString: error.toString(),
                    timestamp: new Date().toISOString(),
                    network: NETWORKS[currentNetwork]?.name || 'Unknown',
                    contract: CONTRACT_ADDRESS,
                    wallet: PRIVATE_KEY.substring(0, 10) + '...',
                    userAgent: navigator.userAgent,
                    ethersVersion: ethers?.version || 'Unknown'
                };

                let errorMessage = error.message;
                let errorDetails = error.message;
                let isDetailedError = true; // Always show full details for testing
                
                // Make error messages more user-friendly
                if (errorMessage.includes('Text already used') || errorMessage.includes('text hash already used')) {
                    errorMessage = '‚ùå This text has already been minted! Try a different text like "MAT", "WELCOME", or "HELLO".';
                    errorDetails = 'Text Uniqueness Error: The contract requires all text to be unique across all NFTs. Please use different text for your rug.';
                } else if (errorMessage.includes('UNPREDICTABLE_GAS_LIMIT')) {
                    const networkInfo = currentNetwork === 'local' ? 'Local Anvil (unlimited funds)' : 'Shape Testnet';
                    errorMessage = `‚ùå Transaction failed on ${networkInfo}. Check details below.`;
                    errorDetails = `Gas Estimation Error on ${networkInfo}:\n\nPossible causes:\n‚Ä¢ Insufficient ETH balance (${currentNetwork === 'local' ? 'Should have unlimited on local' : 'Check testnet wallet'})\n‚Ä¢ Duplicate text (already minted)\n‚Ä¢ Contract is paused\n‚Ä¢ Invalid transaction parameters\n\nCurrent wallet: ${PRIVATE_KEY.substring(0, 10)}...\nNetwork: ${NETWORKS[currentNetwork].name}\n\n${currentNetwork === 'local' ? 'üí° Local network should work with unlimited funds' : 'üí° Check testnet wallet balance and network connection'}`;
                } else if (errorMessage.includes('Invalid text length') || errorMessage.includes('text length')) {
                    errorMessage = '‚ùå Invalid text length. Please use 1-5 lines of text.';
                    errorDetails = 'Text Length Error: The contract only accepts 1-5 lines of text. Empty lines don\'t count.';
                } else if (errorMessage.includes('Max supply reached') || errorMessage.includes('supply')) {
                    errorMessage = '‚ùå Maximum supply reached. No more rugs can be minted.';
                    errorDetails = 'Supply Limit Error: All 1111 rugs have been minted. No more can be created.';
                } else if (errorMessage.includes('insufficient funds') || errorMessage.includes('Insufficient')) {
                    errorMessage = '‚ùå Insufficient funds. Please check your wallet balance.';
                    errorDetails = 'Balance Error: You don\'t have enough ETH to cover the minting cost. The transaction requires more ETH than your current balance.';
                } else if (errorMessage.includes('user rejected') || errorMessage.includes('User denied')) {
                    errorMessage = '‚ùå Transaction cancelled by user.';
                    errorDetails = 'User Cancellation: You cancelled the transaction in your wallet. No action was taken.';
                } else if (errorMessage.includes('ERC721NonexistentToken') || errorMessage.includes('0x7e273289')) {
                    errorMessage = '‚ùå Token does not exist. Try a different token ID.';

                    // Try to extract the token ID from the error context
                    let attemptedTokenId = 'Unknown';
                    try {
                        // Check if we're in a loadNFT context
                        const tokenIdInput = document.getElementById('tokenId');
                        if (tokenIdInput) {
                            attemptedTokenId = tokenIdInput.value;
                        }
                    } catch (e) {
                        // Ignore
                    }

                    // Try to get contract stats
                    let contractStatsText = '';
                    try {
                        const contractStats = document.getElementById('contractStats');
                        if (contractStats) {
                            const stats = JSON.parse(contractStats.textContent);
                            contractStatsText = `\n‚Ä¢ Total NFTs minted: ${stats.totalSupply}/${stats.maxSupply}`;
                        }
                    } catch (e) {
                        // Ignore
                    }

                    errorDetails = `Token Not Found: The NFT with ID ${attemptedTokenId} does not exist in this collection.\n\nWhat this means:\n‚Ä¢ This token ID has never been minted\n‚Ä¢ The token might have been burned (unlikely)\n‚Ä¢ You might be on the wrong network/contract${contractStatsText}\n\nSuggestions:\n‚Ä¢ Try token ID 1 (first minted NFT)\n‚Ä¢ Check if any NFTs have been minted yet\n‚Ä¢ Make sure you're on the correct network\n‚Ä¢ Verify the contract address\n\nCurrent Network: ${NETWORKS[currentNetwork].name}\nContract: ${CONTRACT_ADDRESS}`;
                    isDetailedError = true;
                } else if (errorMessage.includes('execution reverted') || errorMessage.includes('revert')) {
                    errorMessage = '‚ùå Transaction reverted by contract. Check details below.';

                    // Safely get current parameters
                    let currentText = 'N/A';
                    let currentLines = 0;
                    let currentSeed = 'N/A';

                    try {
                        const textRows = document.getElementById('textRows').value.split('\n').filter(line => line.trim()).map(line => line.toUpperCase());
                        currentText = textRows.join(' ').substring(0, 50) + (textRows.join(' ').length > 50 ? '...' : '');
                        currentLines = textRows.length;
                        currentSeed = document.getElementById('seed').value;
                    } catch (e) {
                        // Ignore errors when getting form values
                    }

                    errorDetails = `Contract Execution Failed: The smart contract rejected this transaction.\n\nMost likely causes:\n‚Ä¢ Duplicate text (text hash already exists)\n‚Ä¢ Invalid parameters (check inputs)\n‚Ä¢ Contract paused or in maintenance\n‚Ä¢ Insufficient funds (should have unlimited on local)\n\nCurrent Parameters:\n‚Ä¢ Text: "${currentText}"\n‚Ä¢ Lines: ${currentLines}\n‚Ä¢ Seed: ${currentSeed}\n‚Ä¢ Network: ${NETWORKS[currentNetwork].name}\n‚Ä¢ Wallet: ${PRIVATE_KEY.substring(0, 10)}...\n\nTry with different text or check contract status.`;
                    isDetailedError = true;
                } else {
                    errorMessage = '‚ùå Transaction failed. See error details below.';
                    errorDetails = 'Unknown Error: An unexpected error occurred. Please check the full error details below.';
                    isDetailedError = true;
                }

                // Create PURE CSS error display - NO INLINE STYLES
                const errorHtml = `
                    <div class="error-display">
                        <div class="error-message">${errorMessage}</div>

                        <div class="error-section">
                            <div class="error-content error-friendly">
                                ${errorDetails.replace(/\n/g, '<br>')}
                            </div>
                        </div>

                        <div class="error-button-container">
                            <button onclick="copyErrorDetails('${errorDetails.replace(/'/g, "\\'").replace(/"/g, '\\"')}')" class="error-copy-btn">
                                üìã Copy User-Friendly Details
                            </button>
                        </div>

                        <div class="error-technical-container">
                            <div class="error-technical-header">
                                üîß FULL TECHNICAL ERROR DETAILS
                            </div>
                            <div class="error-technical-content">

                                <div class="error-section">
                                    <div class="error-label">Technical Error:</div>
                                    <div class="error-content error-tech-message">
                                        ${fullTechnicalError.message}
                                    </div>
                                </div>

                                <div class="error-section">
                                    <div class="error-label">Stack Trace:</div>
                                    <div class="error-content error-stack-trace">
                                        ${fullTechnicalError.stack}
                                    </div>
                                </div>

                                <div class="error-section">
                                    <div class="error-label">Error Properties:</div>
                                    <div class="error-content error-properties">
                                        Name: ${fullTechnicalError.name}<br>
                                        Code: ${fullTechnicalError.code}<br>
                                        Data: ${fullTechnicalError.data}
                                    </div>
                                </div>

                                <div class="error-section">
                                    <div class="error-label">Context Information:</div>
                                    <div class="error-content error-context">
                                        Timestamp: ${fullTechnicalError.timestamp}<br>
                                        Network: ${fullTechnicalError.network}<br>
                                        Contract: ${fullTechnicalError.contract}<br>
                                        Wallet: ${fullTechnicalError.wallet}<br>
                                        Ethers.js: ${fullTechnicalError.ethersVersion}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="error-button-container">
                            <button onclick="copyErrorDetails('${JSON.stringify(fullTechnicalError, null, 2).replace(/'/g, "\\'").replace(/"/g, '\\"')}')" class="error-copy-btn error-copy-main">
                                üìã COPY FULL TECHNICAL ERROR
                            </button>
                        </div>
                    </div>
                `;

                // Error handling complete

                showStatus('mintStatus', errorHtml, 'error');
                hideLoading('mintBtn', 'üé® Mint Rug');
            }
        }

        // OLD FUNCTION COMPLETELY REMOVED - using clean version above at line 1391

        // Copy metadata to clipboard
        function copyMetadata() {
            const metadataJson = document.getElementById('metadataJson');
            if (!metadataJson) {
                showStatus('mintStatus', 'No metadata available to copy', 'error');
                return;
            }
            const text = metadataJson.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                showStatus('mintStatus', '‚úÖ Metadata copied to clipboard!', 'success');
            }).catch(err => {
                showStatus('mintStatus', '‚ùå Failed to copy metadata', 'error');
            });
        }

        // Load the latest minted NFT
        async function loadLatestNFT() {
            try {
                // Check if ethers is loaded
                if (typeof ethers === 'undefined') {
                    return; // Silently fail if ethers not loaded
                }

                // Check if contract address is set
                if (!CONTRACT_ADDRESS || CONTRACT_ADDRESS === '0x0000000000000000000000000000000000000000') {
                    console.log('Contract address not set, skipping latest NFT load');
                    return;
                }

                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, new ethers.providers.JsonRpcProvider(RPC_URL));

                // Find the latest token ID by checking ownership
                let latestTokenId = 0;
                for (let i = 1; i <= 1111; i++) {
                    try {
                        const owner = await contract.ownerOf(i);
                        if (owner !== '0x0000000000000000000000000000000000000000') {
                            latestTokenId = i;
                        }
                    } catch (error) {
                        break; // No more tokens
                    }
                }

                if (latestTokenId === 0) {
                    console.log('No NFTs minted yet');
                    return;
                }
                
                document.getElementById('tokenId').value = latestTokenId.toString();
                loadNFT();
            } catch (error) {
                console.error('Load latest NFT error:', error);
            }
        }

        // Switch network function
        async function switchNetwork() {
            const selector = document.getElementById('networkSelect');
            const selectedNetwork = selector ? selector.value : 'local';

            if (NETWORKS[selectedNetwork]) {
                currentNetwork = selectedNetwork;
                RPC_URL = NETWORKS[selectedNetwork].rpcUrl;
                PRIVATE_KEY = NETWORKS[selectedNetwork].privateKey;
                CONTRACT_ADDRESS = NETWORKS[selectedNetwork].contract || CONTRACT_ADDRESS;

                console.log(`üîÑ Network switched to: ${NETWORKS[currentNetwork].name}`);
                console.log(`üîë PRIVATE_KEY updated to: ${PRIVATE_KEY.substring(0, 10)}...`);
                console.log(`üìÑ CONTRACT_ADDRESS: ${CONTRACT_ADDRESS}`);
                console.log(`üåê RPC_URL: ${RPC_URL}`);

                // Clear contract selector
                document.getElementById('contractSelector').innerHTML = '<option value="">Loading contracts...</option>';

                // Clear existing displays
                clearNFTDisplay();
                document.getElementById('mintStatus').innerHTML = '';
                document.getElementById('metadataInfo').classList.add('hidden');

                console.log(`Switched to ${NETWORKS[currentNetwork].name}`);
                console.log(`RPC: ${RPC_URL}`);

                // Load contracts for the new network
                await refreshContracts();

                // Update wallet info for the new network
                await updateWalletInfo();
            }
        }

        // Refresh contracts function
        async function refreshContracts() {
            console.log('Refreshing contracts...');
            await scanForContracts();
            updateContractSelector();
        }

        // Select contract function
        function selectContract() {
            const selector = document.getElementById('contractSelector');
            CONTRACT_ADDRESS = selector.value;
            updateContractDisplay();

            // Clear any existing status messages
            document.getElementById('mintStatus').innerHTML = '';
            clearNFTDisplay();
            document.getElementById('metadataInfo').classList.add('hidden');

            console.log(`Selected contract: ${CONTRACT_ADDRESS}`);
        }

        // Initialize the page
        window.onload = function() {
            // Wait a bit for ethers to load (in case of fallback)
            setTimeout(function() {
                // Check if ethers is loaded
                if (typeof ethers === 'undefined') {
                    console.error('Ethers.js failed to load after timeout');
                    document.body.innerHTML += '<div style="position: fixed; top: 0; left: 0; width: 100%; background: red; color: white; padding: 10px; text-align: center; z-index: 9999;">‚ö†Ô∏è Ethers.js failed to load. Please refresh the page or check your internet connection.</div>';
                    return;
                }
                
                console.log('Ethers.js loaded successfully');
                
                    // Load config from API (with fallback)
                    async function initializeConfig() {
                        console.log('üöÄ Initializing config...');
                        updateConfigStatus(false); // Show loading state

                        // Update contract info status
                        const contractInfo = document.getElementById('contractInfo');
                        if (contractInfo) {
                            contractInfo.innerHTML = '<strong>Status:</strong> <span style="color: blue;">Loading configuration...</span><br><strong>Contracts Found:</strong> <span id="contractCount">0</span>';
                        }

                        // Try to load from API first
                        const apiSuccess = await loadConfigFromAPI();

                        if (apiSuccess && checkConfigLoaded()) {
                            console.log('‚úÖ Config loaded from API, proceeding...');
                // Initialize network and scan for contracts
                            await switchNetwork();
                            return;
                        }

                        // If API fails, use fallback
                        console.log('‚ùå API config failed, using fallback...');
                        loadFallbackConfig();
                        if (checkConfigLoaded()) {
                            console.log('‚úÖ Fallback config worked, proceeding...');
                            // Initialize network and scan for contracts
                            await switchNetwork();
                            return;
                        }

                        // If everything fails
                        document.body.innerHTML += '<div style="position: fixed; top: 0; left: 0; width: 100%; background: orange; color: white; padding: 10px; text-align: center; z-index: 9999;">‚ö†Ô∏è Config loading failed! Start config server with: npm run config-server<br><button onclick="location.reload()" style="margin-top: 5px; padding: 5px 10px;">Reload Page</button></div>';
                    }

                    initializeConfig();
                
                // Update wallet information
                updateWalletInfo();
                
                // Initialize character map display
                initializeCharacterMap();

                // Initialize hidden fields
                updateHiddenFields();

                // Show a helpful message for testing
                console.log('üöÄ Mint UI loaded! Features:');
                console.log('‚Ä¢ Dynamic contract discovery');
                console.log('‚Ä¢ Custom parameter controls');
                console.log('‚Ä¢ Full algorithm integration');
                console.log('‚Ä¢ No Scripty.sol dependency');
                console.log('‚Ä¢ Fixed: Token IDs start from 1 (not 0)');
                console.log('‚Ä¢ Fixed: Token existence validation');
                console.log('‚Ä¢ Fixed: Proper mint success detection');

                console.log(' ');

                console.log('üöÄ Onchain Rugs - Ready for Minting!');
                console.log('Available Commands:');
                console.log('   loadNFT() - Load NFT by token ID');
                console.log('   getContractInfo() - Check contract status');
                console.log('   calculatePrice() - Calculate mint price');
                
                // Load latest NFT if available (with error handling)
                setTimeout(async () => {
                try {
                        if (CONTRACT_ADDRESS) {
                    loadLatestNFT();
                        }
                } catch (error) {
                        console.log('Could not load latest NFT:', error.message);
                }
                }, 2000); // Wait for contract scanning to complete
            }, 1000); // Wait 1 second for ethers to load
        };
    </script>
    
</body>
</html>
