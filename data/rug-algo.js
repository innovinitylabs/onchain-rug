function setup(){noiseSeed(s),window.d=function($){window.prngSeed=$%2147483647,window.prngSeed<=0&&(window.prngSeed+=2147483646)},window.b=function(){return window.prngSeed=16807*window.prngSeed%2147483647,(window.prngSeed-1)/2147483646},window.a=function($,t){return $+window.b()*(t-$)},window.c=function($){return $[Math.floor(window.b()*$.length)]},window.d(s);let R=h+4*f,F=w+4*f;createCanvas(R+2*55,F+2*55).parent("rug");window.rW=R,window.rH=F,pixelDensity(2.5),u(),gtd(),noLoop()}function u(){if(!p||!p.colors)return;let $=p.colors[0],t=p.colors[0],e=999,l=-1;for(let o of p.colors){let r=color(o),_=(red(r)+green(r)+blue(r))/3;_<e&&(e=_,$=o),_>l&&(l=_,t=o)}dt=lerpColor(color($),color(0),.4),lt=lerpColor(color(t),color(255),.3),window.rgbToXyz=function(r,g,b){r/=255,g/=255,b/=255,r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92,g=g>.04045?Math.pow((g+.055)/1.055,2.4):g/12.92,b=b>.04045?Math.pow((b+.055)/1.055,2.4):b/12.92;return{x:r*.4124+g*.3576+b*.1805,y:r*.2126+g*.7152+b*.0722,z:r*.0193+g*.1192+b*.9505}},window.xyzToLab=function(x,y,z){x/=0.95047,y/=1,z/=1.08883;const f=t=>t>Math.pow(6/29,3)?Math.pow(t,1/3):(1/3)*Math.pow(29/6,2)*t+4/29;return{L:116*f(y)-16,a:500*(f(x)-f(y)),b:200*(f(y)-f(z))}},window.rgbToLab=function(c){const{x,y,z}=window.rgbToXyz(red(c),green(c),blue(c));return window.xyzToLab(x,y,z)},window.deltaE2000=function(lab1,lab2){const{L:L1,a:a1,b:b1}=lab1,{L:L2,a:a2,b:b2}=lab2,kL=1,kC=1,kH=1,deltaLPrime=L2-L1,LBar=(L1+L2)/2,C1=Math.sqrt(a1*a1+b1*b1),C2=Math.sqrt(a2*a2+b2*b2),CBar=(C1+C2)/2,aPrime1=a1*(1+.5*(Math.sqrt(Math.pow(CBar,7)/(Math.pow(CBar,7)+Math.pow(25,7))))),aPrime2=a2*(1+.5*(Math.sqrt(Math.pow(CBar,7)/(Math.pow(CBar,7)+Math.pow(25,7))))),CPrime1=Math.sqrt(aPrime1*aPrime1+b1*b1),CPrime2=Math.sqrt(aPrime2*aPrime2+b2*b2),CBarPrime=(CPrime1+CPrime2)/2,deltaCPrime=CPrime2-CPrime1,hPrime1=Math.atan2(b1,aPrime1)*180/Math.PI,hPrime2=Math.atan2(b2,aPrime2)*180/Math.PI,deltahPrime=Math.abs(hPrime1-hPrime2)<=180?hPrime2-hPrime1:hPrime2-hPrime1>180?hPrime2-hPrime1-360:hPrime2-hPrime1+360,deltaHPrime=2*Math.sqrt(CPrime1*CPrime2)*Math.sin(deltahPrime*Math.PI/360),HBarPrime=Math.abs(hPrime1-hPrime2)<=180?(hPrime1+hPrime2)/2:hPrime1+hPrime2>=360?(hPrime1+hPrime2)/2:(hPrime1+hPrime2+360)/2,T=1-.17*Math.cos(HBarPrime*Math.PI/180-30)+.24*Math.cos(2*HBarPrime*Math.PI/180)+.32*Math.cos(3*HBarPrime*Math.PI/180+6)-.2*Math.cos(4*HBarPrime*Math.PI/180-63),SL=1+(.015*Math.pow(LBar-50,2))/Math.sqrt(20+Math.pow(LBar-50,2)),SC=1+.045*CBarPrime,SH=1+.015*CBarPrime*T,RT=-Math.sin(2*(HBarPrime*Math.PI/180-55)*Math.PI/180)*(2*Math.sqrt(Math.pow(CBarPrime,7)/(Math.pow(CBarPrime,7)+Math.pow(25,7)))),kL_SL=kL*SL,kC_SC=kC*SC,kH_SH=kH*SH,termL=deltaLPrime/kL_SL,termC=deltaCPrime/kC_SC,termH=deltaHPrime/kH_SH;return Math.sqrt(termL*termL+termC*termC+termH*termH+RT*termC*termH)},window.perceptualColorDistance=function(a,b){const lab1=window.rgbToLab(a),lab2=window.rgbToLab(b);return window.deltaE2000(lab1,lab2)},window.getTextColorForMixed=function($,A,C,U){const sampleColors=[],checkRadius=2;for(let dx=-checkRadius;dx<=checkRadius;dx++)for(let dy=-checkRadius;dy<=checkRadius;dy++){if(dx===0&&dy===0)continue;let checkX=A+dx,checkY=C+dy;if(checkY<$.y||checkY>=$.y+$.h||checkX<0||checkX>=w)continue;let checkWeftColor=color($.pc);noise(checkX*.1,checkY*.1)>.5&&(checkWeftColor=color($.sc));sampleColors.push(checkWeftColor)}sampleColors.length===0&&sampleColors.push(color($.pc));const toRelativeLuminance=c=>{const convert=v=>{const ch=v/255;return ch<=.03928?ch/12.92:Math.pow((ch+.055)/1.055,2.4)},rLum=convert(red(c)),gLum=convert(green(c)),bLum=convert(blue(c));return.2126*rLum+.7152*gLum+.0722*bLum},contrastRatio=(a,b)=>{const lumA=toRelativeLuminance(a),lumB=toRelativeLuminance(b),lighter=Math.max(lumA,lumB),darker=Math.min(lumA,lumB);return(lighter+.05)/(darker+.05)},primaryColor=color($.pc),secondaryColor=color($.sc),distinctThreshold=20,isDistinct=candidate=>window.perceptualColorDistance(candidate,primaryColor)>distinctThreshold&&window.perceptualColorDistance(candidate,secondaryColor)>distinctThreshold,candidateColors=[],candidateKeys=new Set,addColor=c=>{const key=Math.round(red(c))+'-'+Math.round(green(c))+'-'+Math.round(blue(c));!candidateKeys.has(key)&&(candidateKeys.add(key),candidateColors.push(c))},allPaletteColors=[];p.colors&&p.colors.forEach(pc=>allPaletteColors.push(color(pc)));const usedColors=new Set,primaryKey=Math.round(red(primaryColor))+'-'+Math.round(green(primaryColor))+'-'+Math.round(blue(primaryColor)),secondaryKey=Math.round(red(secondaryColor))+'-'+Math.round(green(secondaryColor))+'-'+Math.round(blue(secondaryColor));usedColors.add(primaryKey),usedColors.add(secondaryKey);const unusedPaletteColors=[];allPaletteColors.forEach(paletteColor=>{const colorKey=Math.round(red(paletteColor))+'-'+Math.round(green(paletteColor))+'-'+Math.round(blue(paletteColor));!usedColors.has(colorKey)&&unusedPaletteColors.push(paletteColor)});unusedPaletteColors.forEach(unusedColor=>{const lightness=(red(unusedColor)+green(unusedColor)+blue(unusedColor))/(3*255),darkenAmount=lightness>.7?.15:lightness>.4?.2:.25,adjusted=lerpColor(unusedColor,color(0,0,0),darkenAmount);addColor(adjusted)});candidateColors.length===0&&allPaletteColors.forEach(paletteColor=>{const lightness=(red(paletteColor)+green(paletteColor)+blue(paletteColor))/(3*255),darkenAmount=lightness>.7?.15:lightness>.4?.2:.25,adjusted=lerpColor(paletteColor,color(0,0,0),darkenAmount);addColor(adjusted)});const evaluateCandidates=pool=>{let bestCandidate=pool[0],bestScore=-1;pool.forEach(candidate=>{let minContrastRatio=Infinity,minPerceptualDistance=Infinity;sampleColors.forEach(sampleColor=>{const ratio=contrastRatio(candidate,sampleColor);ratio<minContrastRatio&&(minContrastRatio=ratio);const perceptualDist=window.perceptualColorDistance(candidate,sampleColor);perceptualDist<minPerceptualDistance&&(minPerceptualDistance=perceptualDist)});const perceptualWeight=.7,contrastWeight=.3,normalizedPerceptual=Math.min(minPerceptualDistance/50,1),normalizedContrast=Math.min(minContrastRatio/7,1),combinedScore=perceptualWeight*normalizedPerceptual+contrastWeight*normalizedContrast;combinedScore>bestScore&&(bestScore=combinedScore,bestCandidate=candidate)});return{bestCandidate:bestCandidate,bestScore:bestScore}};let{bestCandidate:bestCandidate,bestScore:bestScore}=evaluateCandidates(candidateColors);const desiredCombinedScore=.6;if(bestScore<desiredCombinedScore&&allPaletteColors.length>0){const allPaletteCandidates=[];allPaletteColors.forEach(paletteColor=>{const lightness=(red(paletteColor)+green(paletteColor)+blue(paletteColor))/(3*255),darkenAmount=lightness>.7?.15:lightness>.4?.2:.25,darkenedColor=lerpColor(paletteColor,color(0,0,0),darkenAmount);allPaletteCandidates.push(darkenedColor);const lightenAmount=lightness<.3?.2:lightness<.6?.15:.1,lightenedColor=lerpColor(paletteColor,color(255,255,255),lightenAmount);allPaletteCandidates.push(lightenedColor);const r=red(paletteColor)/255,g=green(paletteColor)/255,b=blue(paletteColor)/255,brightness=(r+g+b)/3,contrastR=brightness>.5?Math.max(0,r-.4):Math.min(1,r+.4),contrastG=brightness>.5?Math.max(0,g-.4):Math.min(1,g+.4),contrastB=brightness>.5?Math.max(0,b-.4):Math.min(1,b+.4);allPaletteCandidates.push(color(contrastR*255,contrastG*255,contrastB*255))});const fallbackResult=evaluateCandidates(allPaletteCandidates);bestCandidate=fallbackResult.bestCandidate}return bestCandidate}}function draw(){noStroke();fill(222,222,222);rect(0,0,width,height);push();translate(width/2,height/2);rotate(PI/2);translate(-rH/2,-rW/2);push();translate(2*f,2*f);for(let $ of sd)ds($);tl>0&&dtol(Math.floor(tl));pop();df();dl>0&&ddo(Math.floor(dl));dRF(w,h);pop()}function ds($){let t=wp+1,e=wt+1;for(let l=0;l<w;l+=t)for(let o=$.y;o<$.y+$.h;o+=e){let r=color($.pc),_=!1;if(td.length>0){for(let n of td)if(l>=n.x&&l<n.x+n.width&&o>=n.y&&o<n.y+n.height){_=!0;break}}let i=red(r)+window.a(-15,15),a=green(r)+window.a(-15,15),c=blue(r)+window.a(-15,15);if(_){let d=(i+a+c)/3,g=d<128?lt:dt;i=red(g),a=green(g),c=blue(g)}i=constrain(i,0,255),a=constrain(a,0,255),c=constrain(c,0,255),fill(i,a,c),noStroke();rect(l+.5*sin(.05*o),o,wp,e)}for(let y=$.y;y<$.y+$.h;y+=e)for(let b=0;b<w;b+=t){let m=color($.pc),S=!1;if(td.length>0){for(let x of td)if(b>=x.x&&b<x.x+x.width&&y>=x.y&&y<x.y+x.height){S=!0;break}}if("m"===$.wt&&$.sc)noise(.1*b,.1*y)>.5&&(m=color($.sc));else if("t"===$.wt){let k=noise(.05*b,.05*y);m=lerpColor(color($.pc),color(255),.15*k)}let A=red(m)+window.a(-20,20),C=green(m)+window.a(-20,20),U=blue(m)+window.a(-20,20);if(S){fill(0,0,0,120);noStroke();let v=.5*cos(.05*b);rect(b+.5,y+v+.5,t,wt);let q;if("m"===$.wt&&$.sc)q=window.getTextColorForMixed($,b,y,U);else{let d=(A+C+U)/3;q=d<128?window.lightTextColor:window.darkTextColor}A=red(q),C=green(q),U=blue(q)}A=constrain(A,0,255),C=constrain(C,0,255),U=constrain(U,0,255),fill(A,C,U),noStroke();let v=.5*cos(.05*b);rect(b,y+v,t,wt)}for(let z=$.y;z<$.y+$.h;z+=2*e)for(let B=0;B<w;B+=2*t)fill(0,0,0,40),noStroke(),rect(B+1,z+1,t-2,e-2);for(let D=$.y+e;D<$.y+$.h;D+=2*e)for(let E=t;E<w;E+=2*t)fill(255,255,255,30),noStroke(),rect(E,D,t-1,e-1)}function dto(){push(),blendMode(MULTIPLY);for(let $=0;$<w;$+=2)for(let t=0;t<h;t+=2){let e;fill(0,0,0,map(noise(.02*$,.02*t),0,1,0,50)),noStroke(),rect($,t,2,2)}for(let l=0;l<w;l+=6)for(let o=0;o<h;o+=6){let r=noise(.03*l,.03*o);r>.6?(fill(255,255,255,25),noStroke(),rect(l,o,6,6)):r<.4&&(fill(0,0,0,20),noStroke(),rect(l,o,6,6))}pop()}function dtol($){let t=10+19*$,e=5+10*$,l=.7-.05*$;push(),blendMode(MULTIPLY);for(let o=0;o<w;o+=2)for(let r=0;r<h;r+=2){let _;fill(0,0,0,map(noise(.02*o,.02*r),0,1,0,t)),noStroke(),rect(o,r,2,2)}for(let n=0;n<w;n+=6)for(let i=0;i<h;i+=6){let a=noise(.03*n,.03*i);a>l?(fill(255,255,255,e),noStroke(),rect(n,i,6,6)):a<1-l&&(fill(0,0,0,.8*e),noStroke(),rect(n,i,6,6))}if($>=4)for(let c=0;c<w;c+=8)for(let d=0;d<h;d+=8)noise(.01*c,.01*d)>.7&&(fill(0,0,0,15),noStroke(),rect(c,d,8,2));if($>=7)for(let g=0;g<w;g+=4)for(let y=0;y<h;y+=4)noise(.005*g,.005*y)>.8&&(fill(0,0,0,25),noStroke(),rect(g,y,4,1));if($>=9)for(let y=0;y<w;y+=12)for(let b=0;b<h;b+=12)noise(.002*y,.002*b)>.75&&(fill(0,0,0,35),noStroke(),rect(y,b,12,1));pop()}function ddo($){let t=1===$?.5:1,e=1===$?30:60;push(),translate(2*f,2*f);for(let l=0;l<w;l+=3)for(let o=0;o<h;o+=3){let r=window.a(0,1),_=.85*t;if(r>_){let n=window.a(1,4),i=window.a(.5*e,e),a=window.a(60,90),c=window.a(40,60),d=window.a(20,40);fill(a,c,d,i),noStroke(),ellipse(l,o,n,n)}}for(let g=0;g<15*t;g++){let y=window.a(0,w),b=window.a(0,h),m=window.a(8,20),S=window.a(.3*e,.7*e),x=window.a(40,70),k=window.a(25,45),A=window.a(15,30);fill(x,k,A,S),noStroke(),ellipse(y,b,m,m)}for(let C=0;C<w;C+=2)for(let U=0;U<h;U+=2){let j=Math.min(C,U,w-C,h-U);if(j<10){let q=window.a(0,1);if(q>.7*t){let v=window.a(10,25);fill(80,50,20,v),noStroke(),rect(C,U,2,2)}}}pop()}function df(){dfs(2*f,f,w,f,"top"),dfs(2*f,2*f+h,w,f,"bottom"),dse()}function dfs($,t,e,l,o){let r=e/12,_=e/r;for(let n=0;n<r;n++){let i=$+n*_;if(!p||!p.colors)return;let a=window.c(p.colors);for(let c=0;c<12;c++){let d=i+window.a(-_/6,_/6),g="top"===o?t+l:t,y="top"===o?t:t+l,b=window.a(1,4),m=window.a(.2,.8),S=window.c([-1,1]),x=window.a(.5,2),k=window.a(.8,1.2),A=color(a),C=.7*red(A),U=.7*green(A),j=.7*blue(A);stroke(C,U,j),strokeWeight(window.a(.5,1.2)),noFill(),beginShape();for(let q=0;q<=1;q+=.1){let v=lerp(g,y,q*k),z=sin(q*PI*m)*b*q*S*x;z+=window.a(-1,1),.3>window.b()&&(z+=window.a(-2,2)),vertex(d+z,v)}endShape()}}}function dse(){let $=wt+1;function t(t){let e="left"===t?0:w,l="left"===t?0:PI;for(let o of sd)for(let r=o.y;r<o.y+o.h;r+=$){if(r===o.y||o===sd[sd.length-1]&&r+$>=o.y+o.h)continue;let _=color(o.pc);if(o.sc&&"m"===o.wt){let n=color(o.sc);_=lerpColor(_,n,.5*noise(.1*r)+.5)}let i=.8*red(_),a=.8*green(_),c=.8*blue(_);fill(i,a,c),noStroke();let d=wt*window.a(1.2,1.8),g=2*f+e+window.a(-2,2),y=2*f+r+wt/2+window.a(-1,1),b;dtsa(g,y,d,l+HALF_PI+window.a(-.2,.2),l-HALF_PI+window.a(-.2,.2),i,a,c,t)}}t("left"),t("right")}function dtsa($,t,e,l,o,r,_,n,i){let a=max(6,floor(e/1.2)),c=e/a;for(let d=0;d<a;d++){let g=e-d*c,y,b,m;d%2==0?(y=constrain(r+25,0,255),b=constrain(_+25,0,255),m=constrain(n+25,0,255)):(y=constrain(r-20,0,255),b=constrain(_-20,0,255),m=constrain(n-20,0,255)),fill(y,b,m,88),arc($,t,2*g,2*g,l,o)}fill(.6*r,.6*_,.6*n,70),arc($+("left"===i?1:-1),t+1,2*e,2*e,l,o);for(let S=0;S<5;S++){let x=window.a(l,o),k=e*window.a(.2,.7),A=$+cos(x)*k,C=t+sin(x)*k;fill(r,_,n,120),ellipse(A,C,window.a(1.5,3.5),window.a(1.5,3.5))}}function gtd(){td=[];let $=tr||[];if(!$||0===$.length)return;let t=$.filter($=>$&&""!==$.trim());if(0===t.length)return;let e=wp+1,l=wt+1,o=e*ts,r=l*ts,_=7*o,n=5*r,i=r,a=1.5*_,c=t.length*_+(t.length-1)*a,d=(w-c)/2,g=0;for(let y=0;y<$.length;y++){let b=$[y];if(!b||""===b.trim())continue;let m=_,S=b.length*(n+i)-i,x=d+g*(_+a),k=(h-S)/2;for(let A=0;A<b.length;A++){let C=b.charAt(A),U=k+(b.length-1-A)*(n+i),j=gcp(C,x,U,m,n);td.push(...j)}g++}}function gcp($,t,e,l,o){let r=[],_=wp+1,n=wt+1,i=_*ts,a=n*ts,c=cm[$.toUpperCase()]||cm[" "],d=c.length,g=c[0].length;for(let y=0;y<d;y++)for(let b=0;b<g;b++)if("1"===c[y][b]){let m=y,S=g-1-b;r.push({x:t+m*i,y:e+S*a,width:i,height:a})}return r}