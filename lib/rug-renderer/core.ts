/**
 * Shared Rug Renderer Core Module
 * 
 * This module provides the core rug rendering logic that can be used
 * in both client-side (interactive) and server-side (OG) contexts.
 * 
 * CRITICAL: This module does NOT rewrite rug logic - it provides
 * a unified interface to the existing JavaScript rendering scripts.
 * 
 * The actual rendering is still performed by the same JavaScript
 * scripts (rug-p5.js, rug-algo.js, rug-frame.js) used in the client.
 */

import type { RugRenderParams, RugRenderResult, RenderMode } from './types'

/**
 * Prepare rendering parameters for OG mode
 * 
 * In OG mode, we disable:
 * - Dirt textures (dl = 0)
 * - Aging/decay (tl = 0)  
 * - Frames (fl = 'None')
 * 
 * This ensures clean, consistent preview images for social sharing.
 */
export function prepareOGRenderParams(params: RugRenderParams): RugRenderParams {
  if (params.renderMode === 'og') {
    return {
      ...params,
      textureLevel: 0,
      dirtLevel: 0,
      frameLevel: 'None'
    }
  }
  return params
}

/**
 * Validate rendering parameters
 */
export function validateRenderParams(params: RugRenderParams): { valid: boolean; error?: string } {
  if (!params.tokenId || params.tokenId <= 0) {
    return { valid: false, error: 'Invalid tokenId' }
  }
  
  if (!params.palette || !params.palette.colors || params.palette.colors.length === 0) {
    return { valid: false, error: 'Invalid palette' }
  }
  
  if (!params.stripeData || params.stripeData.length === 0) {
    return { valid: false, error: 'Invalid stripeData' }
  }
  
  if (!params.characterMap || Object.keys(params.characterMap).length === 0) {
    return { valid: false, error: 'Invalid characterMap' }
  }
  
  return { valid: true }
}

/**
 * Get character map for rendering
 * 
 * This provides the character map used for text rendering.
 * The same character map is used in both client and server contexts.
 */
export function getCharacterMap(): Record<string, string[]> {
  return {
    'A': ["01110","10001","10001","11111","10001","10001","10001"],
    'B': ["11110","10001","10001","11110","10001","10001","11110"],
    'C': ["01111","10000","10000","10000","10000","10000","01111"],
    'D': ["11110","10001","10001","10001","10001","10001","11110"],
    'E': ["11111","10000","10000","11110","10000","10000","11111"],
    'F': ["11111","10000","10000","11110","10000","10000","10000"],
    'G': ["01111","10000","10000","10011","10001","10001","01111"],
    'H': ["10001","10001","10001","11111","10001","10001","10001"],
    'I': ["11111","00100","00100","00100","00100","00100","11111"],
    'J': ["11111","00001","00001","00001","00001","10001","01110"],
    'K': ["10001","10010","10100","11000","10100","10010","10001"],
    'L': ["10000","10000","10000","10000","10000","10000","11111"],
    'M': ["10001","11011","10101","10001","10001","10001","10001"],
    'N': ["10001","11001","10101","10011","10001","10001","10001"],
    'O': ["01110","10001","10001","10001","10001","10001","01110"],
    'P': ["11110","10001","10001","11110","10000","10000","10000"],
    'Q': ["01110","10001","10001","10001","10101","10010","01101"],
    'R': ["11110","10001","10001","11110","10100","10010","10001"],
    'S': ["01111","10000","10000","01110","00001","00001","11110"],
    'T': ["11111","00100","00100","00100","00100","00100","00100"],
    'U': ["10001","10001","10001","10001","10001","10001","01110"],
    'V': ["10001","10001","10001","10001","10001","01010","00100"],
    'W': ["10001","10001","10001","10001","10101","11011","10001"],
    'X': ["10001","10001","01010","00100","01010","10001","10001"],
    'Y': ["10001","10001","01010","00100","00100","00100","00100"],
    'Z': ["11111","00001","00010","00100","01000","10000","11111"],
    ' ': ["00000","00000","00000","00000","00000","00000","00000"],
    '0': ["01110","10001","10011","10101","11001","10001","01110"],
    '1': ["00100","01100","00100","00100","00100","00100","01110"],
    '2': ["01110","10001","00001","00010","00100","01000","11111"],
    '3': ["11110","00001","00001","01110","00001","00001","11110"],
    '4': ["00010","00110","01010","10010","11111","00010","00010"],
    '5': ["11111","10000","10000","11110","00001","00001","11110"],
    '6': ["01110","10000","10000","11110","10001","10001","01110"],
    '7': ["11111","00001","00010","00100","01000","01000","01000"],
    '8': ["01110","10001","10001","01110","10001","10001","01110"],
    '9': ["01110","10001","10001","01111","00001","00001","01110"],
    '?': ["01110","10001","00001","00010","00100","00000","00100"],
    '_': ["00000","00000","00000","00000","00000","00000","11111"],
    '!': ["00100","00100","00100","00100","00100","00000","00100"],
    '@': ["01110","10001","10111","10101","10111","10000","01110"],
    '#': ["01010","01010","11111","01010","11111","01010","01010"],
    '$': ["00100","01111","10000","01110","00001","11110","00100"],
    '&': ["01100","10010","10100","01000","10101","10010","01101"],
    '%': ["10001","00010","00100","01000","10000","10001","00000"],
    '+': ["00000","00100","00100","11111","00100","00100","00000"],
    '-': ["00000","00000","00000","11111","00000","00000","00000"],
    '(': ["00010","00100","01000","01000","01000","00100","00010"],
    ')': ["01000","00100","00010","00010","00010","00100","01000"],
    '[': ["01110","01000","01000","01000","01000","01000","01110"],
    ']': ["01110","00010","00010","00010","00010","00010","01110"],
    '*': ["00000","00100","10101","01110","10101","00100","00000"],
    '=': ["00000","00000","11111","00000","11111","00000","00000"],
    "'": ["00100","00100","00100","00000","00000","00000","00000"],
    '"': ["01010","01010","01010","00000","00000","00000","00000"],
    '.': ["00000","00000","00000","00000","00000","00100","00100"],
    '<': ["00010","00100","01000","10000","01000","00100","00010"],
    '>': ["01000","00100","00010","00001","00010","00100","01000"]
  }
}

