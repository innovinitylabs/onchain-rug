<!DOCTYPE html>
<html>
<head>
    <title>Test PNG Punk Loading</title>
</head>
<body>
    <h1>Testing PNG-based CryptoPunk Loading</h1>
    <div id="output"></div>

    <script type="module">
        // Test the PNG loading function
        async function loadPunksImage() {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load punks.png'));
                img.src = 'https://raw.githubusercontent.com/larvalabs/cryptopunks/master/punks.png';
            });
        }

        async function loadCanonicalPunkPixels(punkId) {
            if (punkId < 0 || punkId >= 10000) {
                throw new Error(`Invalid punk ID: ${punkId}`);
            }

            const row = Math.floor(punkId / 100);
            const col = punkId % 100;
            const sx = col * 24;
            const sy = row * 24;

            try {
                const punksImg = await loadPunksImage();
                const canvas = document.createElement('canvas');
                canvas.width = 24;
                canvas.height = 24;
                const ctx = canvas.getContext('2d');

                if (!ctx) {
                    throw new Error('Could not get canvas context');
                }

                ctx.drawImage(punksImg, sx, sy, 24, 24, 0, 0, 24, 24);
                const imageData = ctx.getImageData(0, 0, 24, 24);
                const data = imageData.data;

                const pixels = Array(24).fill(null).map(() => Array(24).fill(null));
                let coloredPixels = 0;

                for (let y = 0; y < 24; y++) {
                    for (let x = 0; x < 24; x++) {
                        const index = (y * 24 + x) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        const a = data[index + 3];

                        if (a > 0) {
                            pixels[y][x] = { r, g, b };
                            coloredPixels++;
                        }
                    }
                }

                return { pixels, coloredPixels, row, col };
            } catch (error) {
                throw error;
            }
        }

        async function testPunks() {
            const output = document.getElementById('output');
            const testPunks = [0, 1, 3100, 7804];

            output.innerHTML = '<h2>Loading punks.png...</h2>';

            try {
                // Test loading the PNG first
                await loadPunksImage();
                output.innerHTML += '<p>‚úÖ punks.png loaded successfully!</p>';

                // Test individual punks
                for (const punkId of testPunks) {
                    output.innerHTML += `<h3>Testing Punk #${punkId}</h3>`;

                    try {
                        const result = await loadCanonicalPunkPixels(punkId);
                        output.innerHTML += `<p>‚úÖ Punk #${punkId} loaded: ${result.coloredPixels} colored pixels (row ${result.row}, col ${result.col})</p>`;

                        // Show a few sample pixels
                        const samples = [];
                        for (let y = 0; y < Math.min(3, result.pixels.length); y++) {
                            for (let x = 0; x < Math.min(3, result.pixels[y].length); x++) {
                                if (result.pixels[y][x]) {
                                    const p = result.pixels[y][x];
                                    samples.push(`(${x},${y}): rgb(${p.r},${p.g},${p.b})`);
                                }
                            }
                        }
                        if (samples.length > 0) {
                            output.innerHTML += `<p>Sample pixels: ${samples.join(', ')}</p>`;
                        }

                    } catch (error) {
                        output.innerHTML += `<p>‚ùå Failed to load punk #${punkId}: ${error.message}</p>`;
                    }
                }

                output.innerHTML += '<h2>üéâ Test complete!</h2>';

            } catch (error) {
                output.innerHTML += `<p>‚ùå Failed to load punks.png: ${error.message}</p>`;
            }
        }

        testPunks();
    </script>
</body>
</html>